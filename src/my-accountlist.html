<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/bwt-datatable/bwt-datatable-card.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/paper-search/paper-search-bar.html">
<link rel="import" href="../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../bower_components/neon-animation/web-animations.html">

<link rel="import" href="my-icons.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="short-unique-id.html">
<link rel="import" href="my-accountlist-new.html">
<link rel="import" href="my-accountlist-edit.html">
<dom-module id="my-accountlist">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
      }

      app-header {
        color: rgb(255, 255, 255);
        background-color: #388E3C;
      }

      paper-button.indigo {
        background-color: var(--paper-indigo-500);
        color: white;
        height: 30px;
        --paper-button-raised-keyboard-focus: {
          background-color: var(--paper-pink-a200) !important;
          color: white;
        }
        ;
      }

      paper-fab.fab-menu {
        position: fixed;
        bottom: 32px;
        right: 32px;
      }

      paper-dialog#editUser,
      #addUser {
        width: 60%;
        margin: 0 auto;
        padding: 16px;
        margin-top: 2%
      }

      h2 {
        margin-top: 2px;
      }

      paper-toast {
        width: 20%;
        position: fixed;
        bottom: 1opx;
        left: 10px;
        margin-left: 20%;
      }

      paper-icon-button.delete {
        color: rgb(233, 79, 164);
      }

      paper-icon-button.edit {
        color: rgb(233, 79, 164);
      }

      paper-search-bar#searching {
        color: #388E3C
      }

      paper-button#done {
        background: white;
        height: 32px;
        font-size: 12px;
        font-weight: 400;
        background: green;
        color: white;
        width: 80px;
      }
    </style>
    <app-route route="{{route}}" pattern="" active="{{applicationActive}}"></app-route>
    <app-route route="{{route}}" pattern="/edit/:key" tail="{{editRoute}}" data="{{editData}}" active="{{editActive}}"></app-route>

    <div hidden$="{{!applicationActive}}">
      <iron-pages selected="[[route.path]]" attr-for-selected="name" fallback-selection="view404" role="main">
        <div name="">

          <app-header-layout fullbleed has-scrolling-region>
            <app-header fixed slot="header">
              <app-toolbar primary>
                <paper-icon-button class="menu" icon="my-icons:menu" drawer-toggle on-tap="toggleDrawer"></paper-icon-button>
                <div main-title id="addAccount">Accounts</div>
                <div main-title id="addNew" style="display:none">New Account</div>
              </app-toolbar>
            </app-header>
            <firebase-query id="query" path="/accountlist" data="{{account}}"></firebase-query>

            <paper-datatable-card style="padding:17px;" header-fixed id-property="$key" header="Accounts" id="datatableCard">

              <div slot="toolbar-select">
                <paper-icon-button class="delete" icon="my-icons:delete-forever" no-ink on-tap="_deleteSelected"></paper-icon-button>
              </div>
              <div slot="toolbar-select-single">
                <a href$="{{_getAccount(keyS)}}">
                  <paper-icon-button class="edit" alt="{{keyS}}" id="{{keyS}}" data-args="{{keyS}}" icon="datatable:editable"></paper-icon-button>
                </a>
              </div>

              <paper-dialog id="deleteUserInfo">
                <br>
                <h2>Delete Account Permanently?</h2>
                <div class="buttons">
                  <paper-button dialog-dismiss autofocus>No</paper-button>
                  <paper-button dialog-confirm on-tap="deleteUser">Yes</paper-button>
                </div>
              </paper-dialog>

              <paper-datatable data="{{account}}" id="datatable" header-fixed multi-selection selectable selected-items="{{selectedItem}}">
                <div no-results>
                  Loading or no more items...
                </div>
                <paper-datatable-column header="Account No" type="String" property="accountkey" sortable></paper-datatable-column>
                <paper-datatable-column header="Name" type="Object" property="name" sortable>
                  <template>
                    <span>[[value.firstname]]</span>
                    <span>[[value.middlename]]</span>
                    <span>[[value.lastname]]</span>
                    <span>[[value.suffix]]</span>
                  </template>
                </paper-datatable-column>
                <paper-datatable-column header="Cellphone" type="String" property="cellphone" sortable></paper-datatable-column>
                <paper-datatable-column header="Role" type="String" property="role" sortable></paper-datatable-column>
                <paper-datatable-column header="Active" type="Boolean" property="active" sortable></paper-datatable-column>
              </paper-datatable>
            </paper-datatable-card>

          </app-header-layout>
          <a href="/accountlist/new" style="text-decoration: none;">
            <paper-fab noink class="fab-menu" on-tap="_appsnew" icon="my-icons:add"></paper-fab>
          </a>
        </div>

        <div name="/new">
          <div id="appnew"></div>
          <my-accountlist-new id="d23" path="" prev-route="{{route.prefix}}"></my-accountlist-new>
        </div>

        <div name="view404">Not found.</div>

      </iron-pages>
      <div hidden$="{{!editActive}}">
        <!-- <template is="dom-if" if="{{_checkIfEditActive(editActive)}}"> -->
        <div id="appedit"></div>
        <my-accountlist-edit id="d25" transaction-key='{{editData.key}}' prev-route="{{route.prefix}}"></my-accountlist-edit>
        <!-- </template> -->
      </div>
      <paper-toast id="toast" text="{{txt}}"></paper-toast>
  </template>

  <script> 
    Polymer({
      is: 'my-accountlist',
      properties: {
        route: Object,
        account: {
          type: Object,
        },
        equal: {
          type: String,
          value: ''
        },
        accountkey: {
          type: String,
          value: ''
        },
        selectedItem: {
          type: String,
          observer: '_selectedItemChanged'
        },
        selectedItems: {
          type: Object,
        },
        keyS: {
          type: String,
          value: ''
        },
        roleAdd: {
          type: Number,
          value: 1
        }
      },
      _getAccount(e) {
        if (e) {
          return '/accountlist/edit/' + e;
        }
      },
      _appsnew() {
        var node = Polymer.dom(this.root).querySelector("#appnew");
        if (node) {
          var oldDiv = Polymer.dom(node.parentNode).querySelector("#d23");
          if (oldDiv) {
            Polymer.dom(node.parentNode).removeChild(oldDiv);
          }
          var newDiv = document.createElement("my-accountlist-new");
          newDiv.setAttribute("id", "d23");
          newDiv.setAttribute("prev-route", this.route.prefix);
          // newDiv.setAttribute("block", "3")
          //if open existing
          var currentDiv = document.getElementById("appnew");
          Polymer.dom(node.parentNode).insertBefore(newDiv, currentDiv);
        }
      },
      editDetails(e) {
        var data_args = Polymer.dom(e).rootTarget.getAttribute("alt");
        var node = Polymer.dom(this.root).querySelector("#appedit");
        if (node) {
          var oldDiv = Polymer.dom(node.parentNode).querySelector("#d25");
          if (oldDiv) {
            Polymer.dom(node.parentNode).removeChild(oldDiv);
          }
          var newDiv = document.createElement("my-accountlist-edit");
          newDiv.setAttribute("id", "d25")
          newDiv.setAttribute("transaction-key", data_args)
          newDiv.setAttribute("prev-route", this.route.prefix);
          //if open existing
          var currentDiv = document.getElementById("appedit");
          Polymer.dom(node.parentNode).insertBefore(newDiv, currentDiv);
        }
      },
      deleteUser() {
        if (this.selectedItems.length > 0) {
          var ref = firebase.database().ref('/accountlist');
          for (var i = 0; i < this.selectedItems.length; ++i) {
            ref.child(this.selectedItems[i].$key).remove();
          }
          Polymer.dom(this.root).querySelector("#toast").open();
          this.txt = "Account successfully deleted.";
          this.$.datatable.deselectAll();
        }
      },
      _deleteSelected() {
        this.$.deleteUserInfo.open();
      },
      _selectedItemChanged() {
        if (this.selectedItem.length > 0) {
          if (this.selectedItem.length > 1) {
            this.selectedItems = this.selectedItem;
            // for (var i = 0; i < this.selectedItem.length; ++i) {
            //   console.log(this.selectedItem[i].$key);
            // }
          }
          else {
            this.myfirstname = this.selectedItem[0].name.firstname;
            this.mymiddlename = this.selectedItem[0].name.middlename;
            this.mylastname = this.selectedItem[0].name.lastname;
            this.mysuffix = this.selectedItem[0].name.suffix;
            this.mycellphone = this.selectedItem[0].cellphone;
            this.roleUpdate = this.selectedItem[0].role;
            this.keyS = this.selectedItem[0].$key;
            this.selectedItems = this.selectedItem;
          }
        }
      },
      toggleDrawer() {
        this.dispatchEvent(new CustomEvent('toggleDrawer', {
          bubbles: true, composed: true, detail: {
            narrow: this.$.narrow
          }
        }));
        this.$.narrow = !this.$.narrow;
      },
    })
  </script>
</dom-module>