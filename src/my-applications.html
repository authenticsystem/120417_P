<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-search/paper-search-bar.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/neon-animation/web-animations.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/iron-list/iron-list.html">
<link rel="import" href="../bower_components/iron-scroll-threshold/iron-scroll-threshold.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/salte-dialog/salte-dialog.html">

<link rel="import" href="shared-styles.html">
<link rel="import" href="time-element.html">
<link rel="import" href="my-application-card.html">
<link rel="import" href="my-application-new.html">
<link rel="import" href="my-application-detail.html">
<link rel="import" href="my-application-edit.html">

<dom-module id="my-applications">
    <template>
        <style include="shared-styles">
            :host {
                display: block;
                /* overflow: hidden; */
            }

            app-header {
                color: rgb(255, 255, 255);
                background-color: #388E3C;
            }

            paper-item {
                font-size: 12px;
                cursor: pointer;
            }

            paper-button {
                height: 32px;
                font-size: 12px;
                font-weight: 400;
                color: #1976d2;
            }

            paper-fab.fab-menu {
                position: fixed;
                right: 32px;
                bottom: 32px;
            }

            a {
                text-decoration: none;
                color: black;
            }
        </style>

        <template is="dom-if" if="{{!access}}">
            <app-header-layout fullbleed has-scrolling-region>
                <app-header fixed slot="header">
                    <app-toolbar primary>
                        <paper-icon-button class="menu" icon="my-icons:menu" drawer-toggle on-tap="toggleDrawer"></paper-icon-button>
                        <div main-title>Opps!</div>
                    </app-toolbar>
                </app-header>
                <div class="card">
                    <h3>Sorry!</h3>
                    <div>You're not allowed to access this content.</div>
                </div>
            </app-header-layout>
        </template>

        <template is="dom-if" if="{{access}}">
            <app-route route="{{route}}" pattern="" active="{{applicationActive}}"></app-route>
            <app-route route="{{route}}" pattern="/detail/:key" tail="{{detailRoute}}" data="{{detailData}}" active="{{detailActive}}"></app-route>
            <app-route route="{{route}}" pattern="/edit/:key" tail="{{editRoute}}" data="{{editData}}" active="{{editActive}}"></app-route>

            <div hidden$="{{!applicationActive}}">
                <iron-pages selected="[[route.path]]" attr-for-selected="name" fallback-selection="view404" role="main">
                    <div name="">
                        <app-header-layout fullbleed has-scrolling-region>
                            <app-header fixed slot="header">
                                <template is="dom-if" if="{{!searchToolbar}}">
                                    <app-toolbar primary>
                                        <paper-icon-button class="menu" icon="my-icons:menu" drawer-toggle on-tap="toggleDrawer"></paper-icon-button>
                                        <div main-title>Applications</div>
                                        <paper-icon-button class="menu" icon="my-icons:search" on-tap="_openSearchToolbar"></paper-icon-button>
                                    </app-toolbar>
                                </template>
                                <template is="dom-if" if="{{searchToolbar}}">
                                    <app-toolbar primary style="background-color: white; color: black">
                                        <div>
                                            <paper-icon-button class="menu" icon="my-icons:arrow-back" on-tap="_closeSearchToolbar"></paper-icon-button>
                                        </div>
                                        <div style="width: 100%">
                                            <paper-search-bar query="{{query}}" placeholder="Search.."
                                                hide-filter-button></paper-search-bar>
                                        </div>
                                        <paper-menu-button vertical-align="top" horizontal-align="right">
                                            <paper-icon-button icon="my-icons:tune" slot="dropdown-trigger" alt="menu"></paper-icon-button>
                                            <paper-listbox slot="dropdown-content" attr-for-selected="name" selected="{{filterBy}}">
                                                <paper-item name="reference">By Reference</paper-item>
                                                <paper-item name="lot">By Lot</paper-item>
                                                <paper-item name="type">By Status</paper-item>
                                                <paper-item name="buyerdetails/lastname">By Buyer Lastname</paper-item>
                                                <paper-item name="agentdetails/lastname">By Agent Lastname</paper-item>
                                            </paper-listbox>
                                        </paper-menu-button>
                                    </app-toolbar>
                                </template>
                                <paper-tabs attr-for-selected="name" selected="{{applicationsTab}}">
                                    <paper-tab name="applicationsNew">New</paper-tab>
                                    <paper-tab name="applications">Approved</paper-tab>
                                </paper-tabs>
                            </app-header>

                            <firebase-query id="applicationsQuery" path="{{applicationsTab}}" data="{{applicationsData}}"
                                limit-to-last="50"></firebase-query>

                            <iron-pages attr-for-selected="name" selected="{{applicationsTab}}">
                                <div name="applicationsNew">
                                    <template is="dom-if" if="{{!hasApplicationsData}}">
                                        <div style="max-width: 900px; margin: 16px auto;">
                                            <paper-card style="width: 100%">
                                                <div style="text-align: center; padding: 16px;">Loading..</div>
                                            </paper-card>
                                        </div>
                                    </template>
                                    <template is="dom-if" if="{{hasApplicationsData}}">
                                        <div style="max-width: 900px; margin: 16px auto">
                                            <iron-list id="list" items="[[applicationsData]]" as="item">
                                                <template>
                                                    <div>
                                                        <a href$="[[_getViewDetailsLink(item.$key)]]" on-tap="viewDetails"
                                                            item="[[item]]">
                                                            <paper-card style="width: 100%; margin-bottom: 16px;">
                                                                <my-application-card item="[[item]]"></my-application-card>
                                                                <!-- <div class="card-actions">
                                                                <span style="float: right; margin-bottom: 4px;">
                                                                    <paper-button on-tap="_openApprovedDialog" item="{{item}}">Approved</paper-button>
                                                                    <paper-button on-tap="_openDisApprovedDialog" item="{{item}}">Disapproved</paper-button>
                                                                </span>
                                                            </div> -->
                                                            </paper-card>
                                                        </a>
                                                    </div>
                                                </template>
                                            </iron-list>
                                        </div>
                                    </template>
                                </div>
                                <div name="applications">
                                    <template is="dom-if" if="{{!hasApplicationsData}}">
                                        <div style="max-width: 900px; margin: 16px auto;">
                                            <paper-card style="width: 100%">
                                                <div style="text-align: center; padding: 16px;">Loading..</div>
                                            </paper-card>
                                        </div>
                                    </template>

                                    <template is="dom-if" if="{{hasApplicationsData}}">
                                        <div style="max-width: 900px; margin: 16px auto">
                                            <iron-list id="list" items="[[applicationsData]]" as="item">
                                                <template>
                                                    <div>
                                                        <paper-card style="width: 100%; margin-bottom: 16px;">
                                                            <my-application-card item="{{item}}"></my-application-card>
                                                            <div class="card-actions">
                                                                <a href$="{{_getEditDetailsLink(item.$key)}}" on-tap="editDetails"
                                                                    item="{{item}}">
                                                                    <paper-button>Edit</paper-button>
                                                                </a>
                                                                <a href$="{{_getViewDetailsLink(item.$key)}}" on-tap="viewDetails"
                                                                    item="{{item}}">
                                                                    <paper-button>View</paper-button>
                                                                </a>
                                                            </div>
                                                        </paper-card>
                                                    </div>
                                                </template>
                                            </iron-list>
                                        </div>
                                    </template>

                                    <a href="/applications/new" style="text-decoration: none;">
                                        <paper-fab noink class="fab-menu" on-tap="_appsnew" icon="my-icons:add"></paper-fab>
                                    </a>

                                </div>
                            </iron-pages>

                            <paper-dialog id="approvedDialog">
                                <p>Approve application request? </p>
                                <div class="buttons">
                                    <paper-button dialog-dismiss>Cancel</paper-button>
                                    <paper-button dialog-confirm autofocus on-tap="_approvedRequest">Approved</paper-button>
                                </div>
                            </paper-dialog>

                            <paper-dialog id="successDialog" no-cancel-on-outside-click>
                                <p>Application request successfully approved!</p>
                                <div class="buttons">
                                    <paper-button dialog-dismiss>OK</paper-button>
                                </div>
                            </paper-dialog>

                            <paper-dialog id="approvedDialogError" no-cancel-on-outside-click>
                                <p>ERROR! Application request can't be process this lot is already
                                    {{dialogDataStatus}}.</p>
                                <div class="buttons">
                                    <paper-button dialog-dismiss>OK</paper-button>
                                </div>
                            </paper-dialog>

                            <salte-dialog id="disApprovedDialog" no-auto-fullscreen>
                                <h2 style$="background-color: {{disApprovedData.lotdetails.maprenderdetails.type_bg_color}}; color: {{disApprovedData.lotdetails.maprenderdetails.type_fore_color}}">
                                    <div>
                                        {{_formatLot(disApprovedData.lotdetails.block, disApprovedData.lotdetails.lot,
                                        disApprovedData.lotdetails.level)}}
                                    </div>
                                    <div style="font-size: 12px">Reference key: {{disApprovedData.reference}}</div>
                                </h2>
                                <div style="color: red">{{msg}}</div>
                                <paper-input label="Reason" always-float-label value="{{reason}}"></paper-input>
                                <div class="buttons">
                                    <paper-button dialog-dismiss>Cancel</paper-button>
                                    <paper-button on-tap="_sudmitDisApproved">Submit</paper-button>
                                </div>
                            </salte-dialog>

                        </app-header-layout>
                    </div>

                    <div name="/new">
                        <div id="appnew"></div>
                        <my-application-new id="d23" path="" myname="{{myname}}" prev-route="{{route.prefix}}"></my-application-new>
                    </div>

                    <div name="view404">Not found.</div>

                </iron-pages>
            </div>

            <div hidden$="{{!detailActive}}">
                <div id="appdetail"></div>
                <my-application-detail id="d24" transaction-key='{{detailData.key}}' prev-route="{{route.prefix}}"
                    path-link="{{applicationsTab}}" myname="{{myname}}" user="{{user}}"></my-application-detail>
            </div>

            <div hidden$="{{!editActive}}">
                <div id="appedit"></div>
                <my-application-edit id="d25" transaction-key='{{editData.key}}' prev-route="{{route.prefix}}" myname="{{myname}}"></my-application-edit>
            </div>
        </template>


    </template>
    <script>
        Polymer({
            is: 'my-applications',

            properties: {
                user: Object,
                account: Object,
                route: Object,
                searchToolbar: {
                    type: Boolean,
                    value: false
                },
                applicationsTab: {
                    type: String,
                    value: 'applicationsNew'
                },
                filterBy: {
                    type: String,
                    value: 'lot'
                },
                applicationsData: Object
            },

            observers: [
                '_accountChanged(account)',
                '_applicationsDataChanged(applicationsData.*)',
                '_queryChanged(query, applicationsTab, filterBy, applicationsData)'
            ],

            _accountChanged(e) {
                if (e.length > 0) {
                    this.myname = e[0].name.firstname + ' ' + e[0].name.middlename + ' ' + e[0].name.lastname;
                }
            },

            _queryChanged(query, applicationsTab, filterBy, applicationsData) {
                var self = this;
                if (query) {
                    firebase.database().ref(applicationsTab).orderByChild(filterBy).equalTo(query).limitToFirst(50).on('value', function (data) {
                        data.val() ? self.applicationsData = Object.values(data.val()) : self.applicationsData = [];
                    });
                } else {
                    if (applicationsTab === 'applications') {
                        this.applicationsData = this.applicationsData.reverse();
                    }
                }
            },

            _applicationsDataChanged(e) {
                if (e.base.length > 0) {
                    this.hasApplicationsData = true;
                }
                else { this.hasApplicationsData = false; }
            },

            _openSearchToolbar() {
                this.searchToolbar = true;
                Polymer.dom(this.root).querySelector("#applicationsQuery").disabled = true;
            },

            _closeSearchToolbar() {
                this.searchToolbar = false;
                Polymer.dom(this.root).querySelector("#applicationsQuery").disabled = false;
            },

            _appsnew() {
                var node = Polymer.dom(this.root).querySelector("#appnew");
                if (node) {
                    var oldDiv = Polymer.dom(node.parentNode).querySelector("#d23");
                    if (oldDiv) {
                        Polymer.dom(node.parentNode).removeChild(oldDiv);
                    }
                    var newDiv = document.createElement("my-application-new");
                    newDiv.setAttribute("id", "d23");
                    newDiv.setAttribute("prev-route", this.route.prefix);
                    newDiv.setAttribute("myname", this.myname);
                    // newDiv.setAttribute("block", "3")
                    //if open existing
                    var currentDiv = document.getElementById("appnew");
                    Polymer.dom(node.parentNode).insertBefore(newDiv, currentDiv);
                }
            },

            _getViewDetailsLink(e) {
                if (e) return '/applications/detail/' + e.toString();
            },

            _getEditDetailsLink(e) {
                if (e) return '/applications/edit/' + e.toString();
            },

            viewDetails(e) {
                // var data_args = Polymer.dom(e).rootTarget.getAttribute("alt");
                var data_args = e.currentTarget.item.$key;
                var node = Polymer.dom(this.root).querySelector("#appdetail");
                if (node) {
                    var oldDiv = Polymer.dom(node.parentNode).querySelector("#d24");
                    if (oldDiv) {
                        Polymer.dom(node.parentNode).removeChild(oldDiv);
                    }
                    var newDiv = document.createElement("my-application-detail");
                    newDiv.setAttribute("id", "d24")
                    newDiv.setAttribute("transaction-key", data_args)
                    newDiv.setAttribute("prev-route", this.route.prefix);
                    newDiv.setAttribute("path-link", this.applicationsTab);
                    newDiv.setAttribute("myname", this.myname);
                    newDiv.setAttribute("user", JSON.stringify(this.user));
                    //if open existing
                    var currentDiv = document.getElementById("appdetail");
                    Polymer.dom(node.parentNode).insertBefore(newDiv, currentDiv);
                }
            },

            editDetails(e) {
                // var data_args = Polymer.dom(e).rootTarget.getAttribute("alt");
                var data_args = e.currentTarget.item.$key;
                var node = Polymer.dom(this.root).querySelector("#appedit");
                if (node) {
                    var oldDiv = Polymer.dom(node.parentNode).querySelector("#d25");
                    if (oldDiv) {
                        Polymer.dom(node.parentNode).removeChild(oldDiv);
                    }
                    var newDiv = document.createElement("my-application-edit");
                    newDiv.setAttribute("id", "d25")
                    newDiv.setAttribute("transaction-key", data_args)
                    newDiv.setAttribute("prev-route", this.route.prefix);
                    newDiv.setAttribute("myname", this.myname);
                    //if open existing
                    var currentDiv = document.getElementById("appedit");
                    Polymer.dom(node.parentNode).insertBefore(newDiv, currentDiv);
                }
            },

            toggleDrawer() {
                this.dispatchEvent(new CustomEvent('toggleDrawer', {
                    bubbles: true, composed: true, detail: {
                        narrow: this.$.narrow
                    }
                }));
                this.$.narrow = !this.$.narrow;
            },

            _openApprovedDialog(e) {
                this.approvedData = e.currentTarget.item;
                var lot = this.approvedData.lot;
                var type = this.approvedData.lotdetails.type + '_available_yes';
                var successDialog = Polymer.dom(this.root).querySelector('#approvedDialog');
                var errorDialog = Polymer.dom(this.root).querySelector('#approvedDialogError');
                var self = this;

                firebase.database().ref('/lots/' + lot).once('value', function (data) {
                    if (data.val().type_status_inventoriable === type) {
                        successDialog.open();
                    } else {
                        self.dialogDataStatus = data.val().status;
                        errorDialog.open();
                    }
                });
            },

            _approvedRequest() {
                var ddate = new Date();
                var startDateTimeValue = ddate.getFullYear() + "-" + ("0" + (ddate.getMonth() + 1)).slice(-2) + "-" + ("0" + ddate.getDate()).slice(-2)
                    + "T" + ("0" + (ddate.getHours())).slice(-2) + ":" + ("0" + ddate.getMinutes()).slice(-2);
                this.expiryHoursDaysLabel = "hours";
                this.expiryHoursDaysValue = 24;
                var xdate = new Date(startDateTimeValue);
                xdate.setHours(xdate.getHours() + this.expiryHoursDaysValue);
                this.expiryHoursDaysComputedValue = xdate.toDateString() + ' ' + xdate.toLocaleTimeString();

                var expiryDate = xdate.getFullYear() + "-" + ("0" + (xdate.getMonth() + 1)).slice(-2) + "-" + ("0" + xdate.getDate()).slice(-2)
                    + "T" + ("0" + xdate.getHours()).slice(-2) + ":" + ("0" + xdate.getMinutes()).slice(-2);

                var dataForApplications = {
                    agent: this.approvedData.agent,
                    agentdetails: this.approvedData.agentdetails,
                    buyer: this.approvedData.buyer,
                    buyerdetails: this.approvedData.buyerdetails,
                    lot: this.approvedData.lot,
                    lotdetails: this.approvedData.lotdetails,
                    expiry: expiryDate,
                    isexpired: false,
                    start: startDateTimeValue,
                    timestamp: { ".sv": "timestamp" },
                    type: this.approvedData.type,
                    reference: this.approvedData.reference,
                    briefcasedetails: {
                        status: 'Approved',
                        dateCreated: this.approvedData.briefcasedetails.dateCreated,
                        isUpdated: this.approvedData.briefcasedetails.isUpdated,
                        dateSendRequest: this.approvedData.briefcasedetails.dateSendRequest,
                        processedBy: this.isMe,
                        dateProcessed: startDateTimeValue,
                    },
                }

                var notificationData = {
                    isRead: false,
                    date: startDateTimeValue,
                    href: '/dashboard/detail/' + this.approvedData.$key,
                    message: this.isMe.name.lastname + ' ' + this.isMe.name.firstname + ' approved your request',
                    agentdetails: this.approvedData.agentdetails,
                    lotdetails: this.approvedData.lotdetails,
                    userPhoto: this.user.photoURL
                }

                var newPostKey = firebase.database().ref().child('briefcase').push().key;

                var updates = {};

                updates["/briefcase/" + this.approvedData.agent + "/" + newPostKey] = dataForApplications;
                updates["/applications/" + newPostKey] = dataForApplications;
                updates["/briefcaseDraft/" + this.approvedData.agent + "/" + this.approvedData.$key] = null;
                updates["/applicationsNew/" + this.approvedData.$key] = null;

                updates['/notificationsUser/' + this.approvedData.agent + '/' + newPostKey] = notificationData;
                // updates['/notifications/' + this.approvedData.$key] = null;

                var isCurrentReservation = false;
                if (this.lastReservation) {
                    if (this.lastReservation.length > 0) {
                        isCurrentReservation = false;
                    }
                    else {
                        isCurrentReservation = true;
                    }
                }
                else {
                    isCurrentReservation = true;
                }

                var dataForReservation = {
                    agent: this.approvedData.agent,
                    agentdetails: this.approvedData.agentdetails,
                    buyer: this.approvedData.buyer,
                    buyerdetails: this.approvedData.buyerdetails,
                    expiry: expiryDate,
                    isexpired: false,
                    start: startDateTimeValue,
                    timestamp: { ".sv": "timestamp" },
                    iscurrent: isCurrentReservation,
                    type: this.approvedData.type,
                    reference: this.approvedData.reference
                }

                updates["/reservations/" + this.approvedData.lot + "/" + newPostKey] = dataForReservation;

                if (isCurrentReservation == true) {
                    updates["/lots/" + this.approvedData.lot + "/reservation"] = this.approvedData.$key;
                    updates["/lots/" + this.approvedData.lot + "/reservationdetails"] = dataForReservation;
                    updates["/lots/" + this.approvedData.lot + "/status"] = 'hold';
                    updates["/lots/" + this.approvedData.lot + "/maprenderdetails/status_name"] = 'Hold';
                    updates["/lots/" + this.approvedData.lot + "/maprenderdetails/bg_color"] = '#E65100';
                    updates["/lots/" + this.approvedData.lot + "/maprenderdetails/fore_color"] = 'white';
                    updates["/lots/" + this.approvedData.lot + "/type_status_inventoriable"] = this.approvedData.lotdetails.type + '_hold_' + this.approvedData.lotdetails.inventoriable;
                    //shb 01/04
                    //for lots with level/map_lot: check other lots by map_lot, compare and get winning map_lot status
                    //get lots thru map_lot
                    if (this.approvedData.lotdetails.level) {
                        var otherLotsRef = firebase.database().ref('lots');
                        var otherLotMapLot = this.approvedData.lot;
                        otherLotsRef.orderByChild('map_lot').equalTo(otherLotMapLot).on('value', snap => {
                            if (snap.exists()) {
                                var winningValStat = 0;
                                snap.forEach(element => {
                                    var valStat = 0;
                                    var stat = element.val().status;
                                    if (stat) {
                                        if (stat === 'available') valStat = 5;
                                        else if (stat === 'hold') valStat = 4;
                                        else if (stat === 'reserved') valStat = 3;
                                        else if (stat === 'soldlacking') valStat = 2;
                                        else if (stat === 'sold') valStat = 1;
                                        else valStat = 0; //notyetavailable
                                    }
                                    if (valStat > winningValStat) {
                                        winningValStat = valStat;
                                    }
                                });

                                var winningColor;
                                if (winningValStat == 5) winningColor = 'available';
                                else if (winningValStat == 4) winningColor = 'hold';
                                else if (winningValStat == 3) winningColor = 'reserved';
                                else if (winningValStat == 2) winningColor = 'soldlacking';
                                else if (winningValStat == 1) winningColor = 'sold';
                                else winningColor = 'notyetavailable';

                                var corresStatusColorRef = firebase.database().ref('statuscolor/' + winningColor);
                                // this.$.fdColor.db.ref('statuscolor/' + winningColor);
                                var transTypeCorrespondingColorRef = firebase.database().ref('statuscolor/hold');
                                transTypeCorrespondingColorRef.on('value', statusColor => {
                                    if (statusColor.exists()) {
                                        corresStatusColor = statusColor.val()
                                        updates["/lots/" + otherLotMapLot + "/status"] = winningColor;
                                        updates["/lots/" + otherLotMapLot + "/maprenderdetails/status_name"] = statusColor.name;
                                        updates["/lots/" + otherLotMapLot + "/maprenderdetails/bg_color"] = statusColor.bg_color;
                                        updates["/lots/" + otherLotMapLot + "/maprenderdetails/fore_color"] = statusColor.fore_color;
                                        updates["/lots/" + otherLotMapLot + "/type_status_inventoriable"] = this.approvedData.type + '_' + winningColor + '_' + 'no';

                                    }
                                });
                            }
                        });
                    }

                }
                //if ok, update bg_color, status_name
                //check reservations if current is expired, then check if there is prior reservation, then iscurrent=false
                firebase.database().ref().update(updates);
                Polymer.dom(this.root).querySelector('#approvedDialog').close();
                Polymer.dom(this.root).querySelector('#successDialog').open();
            },

            _openDisApprovedDialog(e) {
                this.disApprovedData = e.currentTarget.item;
                this.reason = null;
                Polymer.dom(this.root).querySelector('#disApprovedDialog').open();
            },

            _formatLot(block, lot, level) {
                if (level) return 'Block ' + block + ' Lot ' + lot + ' Level ' + level;
                else return 'Block ' + block + ' Lot ' + lot;
            },

            _sudmitDisApproved() {
                if (this.reason) {
                    this.msg = '';

                    var ddate = new Date();
                    var startDateTimeValue = ddate.getFullYear() + "-" + ("0" + (ddate.getMonth() + 1)).slice(-2) + "-" + ("0" + ddate.getDate()).slice(-2)
                        + "T" + ("0" + (ddate.getHours())).slice(-2) + ":" + ("0" + ddate.getMinutes()).slice(-2);

                    var notificationData = {
                        isRead: false,
                        date: startDateTimeValue,
                        href: '/dashboard/detail/' + this.disApprovedData.$key,
                        message: this.isMe.name.lastname + ' ' + this.isMe.name.firstname + ' disapproved your request',
                        agentdetails: this.disApprovedData.agentdetails,
                        lotdetails: this.disApprovedData.lotdetails,
                        userPhoto: this.user.photoURL
                    }

                    var updates = {};

                    updates["/briefcaseDraft/" + this.disApprovedData.agent + "/" + this.disApprovedData.$key + '/briefcasedetails/status'] = 'Disapproved';
                    updates["/briefcaseDraft/" + this.disApprovedData.agent + "/" + this.disApprovedData.$key + '/briefcasedetails/processedBy'] = this.isMe;
                    updates["/briefcaseDraft/" + this.disApprovedData.agent + "/" + this.disApprovedData.$key + '/briefcasedetails/dateProcessed'] = startDateTimeValue;
                    updates["/briefcaseDraft/" + this.disApprovedData.agent + "/" + this.disApprovedData.$key + '/briefcasedetails/reason'] = this.reason;
                    updates["/applicationsNew/" + this.disApprovedData.$key] = null;

                    updates['/notificationsUser/' + this.disApprovedData.agent + '/' + this.disApprovedData.$key] = notificationData;
                    // updates['/notifications/' + this.disApprovedData.$key] = null;

                    firebase.database().ref().update(updates);
                    Polymer.dom(this.root).querySelector('#disApprovedDialog').close();
                } else {
                    this.msg = 'Please provide reason';
                }
            },
        })
    </script>
</dom-module>