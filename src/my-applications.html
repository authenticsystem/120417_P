<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/iron-list/iron-list.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/iron-scroll-threshold/iron-scroll-threshold.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="my-icons.html">
<link rel="import" href="shared-styles.html">

<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="../bower_components/polymerfire/firebase-query.html">

<link rel="import" href="my-application-details.html">

<link rel="import" href="../bower_components/paper-radio-group/paper-radio-group.html">

<link rel="import" href="time-element.html">
<!-- <script src="../bower_components/time-elements/time-elements.js"></script> -->

<link rel="import" href="my-application-card.html">

<dom-module id="my-applications">
  <template>
    <style include="shared-styles">
      :host {
        height: 100vh;
        margin: 0;

        display: flex;
        flex-direction: column;
      }

      .avatar {
        height: 40px;
        width: 40px;
        border-radius: 20px;
        box-sizing: border-box;
        background-color: #DDD;
      }

      .pad {
        padding: 0 16px;
        @apply --layout-flex;
        @apply --layout-vertical;
      }

      .primary {
        font-size: 18px;
        text-transform: capitalize;
      }

      .shortText,
      .longText {
        font-size: 12px;
      }

      .longText {
        color: gray;
        margin-bottom: -0.5em;
      }

      .spacer {
        @apply --layout-flex;
      }

      @media (max-width: 768px) {
        iron-list {
          margin: 16px;
          /* margin-top: 16px; */
          display: flex;
          height: 100vh;
          flex-direction: column;
          border-radius: 3px;
          /* box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2); */
        }
      }

      @media (min-width: 768px) {

        iron-list {
          width: 765px;
          margin: 16px auto;
          /* margin-top: 16px; */
          height: 100vh;
          border-radius: 3px;
          /* box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2); */
        }
      }

      app-header {
        color: rgb(255, 255, 255);
        background-color: #388E3C;
      }

      paper-fab.fab-menu {
        position: fixed;
        right: 32px;
        bottom: 32px;
      }

      paper-fab.fab-search {
        position: fixed;
        right: 40px;
        bottom: 104px;
      }

      paper-icon-button.menu {
        margin-right: 16px;
      }


      .item {
        @apply --layout-horizontal;
        /* padding: 20px; */
        background-color: white;
        border-bottom: 1px solid #ddd;
        cursor: pointer;
        margin-bottom: 10px;
        box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);

      }

      paper-input {
        /* color: white; */
        display: inline-block;
        width: 300px;
        margin-top: -20px;
        border-bottom-color: white;
        display: none;
      }

      paper-dropdown-menu {
        /* color: white; */
        margin-top: -20px;
        display: none;
      }
    </style>

    <app-route route="{{route}}" pattern="/:action" data="{{routeData}}"></app-route>

    <iron-pages selected="[[route.path]]" attr-for-selected="name" fallback-selection="view404" role="main">
      <div name="">
        <!-- <iron-ajax auto url="src/data.json" last-response="{{items}}"></iron-ajax> -->
        <app-header-layout fullbleed has-scrolling-region>
          <app-header fixed slot="header">
            <app-toolbar primary>
              <paper-icon-button class="menu" icon="my-icons:menu" drawer-toggle on-tap="toggleDrawer"></paper-icon-button>
              <div main-title>Applications</div>
              <paper-dropdown-menu style="--paper-dropdown-menu-color:white;" id="child">
                <paper-listbox slot="dropdown-content" selected="{{filterByChild}}" style="cursor:pointer;">
                  <paper-item>By Status</paper-item>
                  <paper-item>By Lot</paper-item>
                  <!-- <paper-item>By Buyer</paper-item> -->
                </paper-listbox>
              </paper-dropdown-menu>
              <paper-dropdown-menu id="status">
                <paper-listbox slot="dropdown-content" selected="{{filterByStatus}}" style="cursor:pointer;">
                  <paper-item>All</paper-item>
                  <paper-item>Buy</paper-item>
                  <paper-item>On-Hold</paper-item>
                  <paper-item>Reserve</paper-item>
                </paper-listbox>
              </paper-dropdown-menu>
              <paper-input id="filterInput" style="--paper-input-container-color:white; --paper-input-container-input-color:white;" label="Search"
                value={{inputtedValue}}></paper-input>
              <paper-icon-button icon="my-icons:search" on-tap="toggleSearch"></paper-icon-button>
            </app-toolbar>
          </app-header>

          <div id="errMsg" style="display:none">No record found!</div>

          <!-- <firebase-query id="query" path="/statuscolor" data="{{statuscolor}}">
                    </firebase-query> -->

          <firebase-query id="query" path="/applications" data="{{applications}}" order-by-child="{{selectedType}}" start-at="{{typeValue}}"
            end-at="{{typeValue}}" limit-to-last="200">
          </firebase-query>

          <iron-scroll-threshold on-lower-threshold="loadMoreData" id="threshold">
            <iron-list items="[[applications]]" as="item" selection-enabled multi-selection scroll-target="threshold">
              <paper-toast id="toast" text="" duration="0"></paper-toast>
              <template>
                <div class="divSeparator">
                  <div class$="[[getClassForItem(item, selected)]]" tabindex$="[[item.$key]]" style="width: 100%;">

                    <my-application-card item="{{item}}"></my-application-card>


                    <!-- <div class="card-content" style="width: 100%;">
                                    <div class="header" style="background-color: #2196F3; padding: 16px; padding-bottom: 5px;">
                                      <span style="background: red; border-radius: 2px; color: white; padding-left: 2px;padding-right: 2px;">
                                        [[item.type]]
                                      </span>
          
                                      <div style="display:inline-block; margin-left: 24px;">
                                        <iron-icon icon="my-icons:access-time" style="color: white;"></iron-icon>
                                        <div style="display:inline-block; color: white; font-size: 12px;">
                                          <time-ago datetime$="{{item.start}}">{{item.start}}</time-ago>
                                        </div>
                                      </div>
          
                                      <paper-menu-button style="display:inline-block;position: absolute;  right: 8px; color: white; top:8px;">
                                        <paper-icon-button icon="my-icons:more-vert" slot="dropdown-trigger" alt="menu"></paper-icon-button>
                                        <paper-listbox slot="dropdown-content">
                                          <paper-item>Lacking</paper-item>
                                          <paper-item>Complete</paper-item>
                                        </paper-listbox>
                                      </paper-menu-button>
          
                                      <div style="margin-top: 24px; color: white; font-weight: 400; font-size: 22px; text-transform:capitalize;">
                                        <span id="block">Block {{item.lotdetails.block}} - Lot {{item.lotdetails.lot}}</span>
                                        <span id="plot">- Level {{item.lotdetails.level}}</span>
                                      </div>
                                      <div style="font-size: 10px; color: white;">
                                        &nbsp;Ref.: [[item.$key]]
                                      </div>
                                    </div>
          
                                    <div style="padding: 16px;">
                                      <div style="padding-bottom: 8px;">
                                        <div style="font-size: 12px; color: darkgray;margin-bottom: -.3em">Buyer</div>
                                        <span style="font-weight: 400;">
                                          [[item.buyerdetails.firstname]] [[item.buyerdetails.middlename]] [[item.buyerdetails.lastname]]
                                        </span>
                                      </div>
                                      <div>
                                        <div style="font-size: 12px; color: darkgray;margin-bottom: -.3em">Agent</div>
                                        <span style="font-weight: 400;">[[item.agentdetails.firstname]] [[item.agentdetails.middlename]] [[item.agentdetails.lastname]]</span>
                                      </div>
                                    </div>
          
                                    <div style="border-top:solid rgba(179, 176, 176, 0.788) 1px; height: 48px; vertical-align:middle;">
                                      <div style="margin-left: 16px; margin-top: 8px;">
                                        <iron-icon icon="my-icons:alarm" style="color: rgba(255, 5, 5, 0.774);"></iron-icon>
                                        <span style="color:rgba(255, 5, 5, 0.774); font-size: 12px;">
                                          <time-until datetime$="{{item.expiry}}">{{item.expiry}}</time-until>
                                        </span>
                                      </div>
                                    </div>
          
                                  </div> -->





                  </div>

                </div>


              </template>
            </iron-list>

          </iron-scroll-threshold>

        </app-header-layout>
        <a href="/applications/new" style="text-decoration: none;">
          <paper-fab noink class="fab-menu" icon="my-icons:add" on-tap="_appsnew"></paper-fab>
        </a>
      </div>

      <div name="/new">
        <div id="appdetails"></div>
        <my-application-details id="d23" path=""></my-application-details>
      </div>

      <div name="view404">Not found.</div>

    </iron-pages>


  </template>

  <script>
    Polymer({
      is: 'my-applications',

      properties: {
        items: {
          type: Array,
          value: function () {
            return [];
          }
        },
        narrow: {
          type: Boolean,
          notify: true
        },
        applications: {
          type: Object,
        },
        filterByChild: {
          type: Number,
          observer: '_filterChild'
        },
        filterByStatus: {
          type: Number,
          observer: '_filterStatus'
        },
        inputtedValue: {
          type: String,
          value: '',
          observer: '_filterInputVal'
        },
        typeValue: {
          type: String,
          value: ''
        },
        selectedType: {
          type: String,
          value: ''
        },
        statuscolor:{
          type: Object,
          observer: '_colorChanged'
        },
        colorSelected: {
          type: String,
          value: ''
        }
      },

      _colorChanged(){
        // this.colorSelected = "LAWN LOTS";
        // console.log(this.colorSelected);
        console.log(this.statuscolor);
      },

      toggleSearch() {
        var listStat = Polymer.dom(this.root).querySelector("#status");
        var input = Polymer.dom(this.root).querySelector("#filterInput");
        var list = Polymer.dom(this.root).querySelector("#child");
        if (list.style.display === "block") {
          listStat.style.display = "none";
          input.style.display = "none";
          list.style.display = "none";
        } else {
          list.style.display = "block";
        }
      },

      _filterInputVal(e) {
        this.typeValue = this.inputtedValue;
      },

      _filterChild(e) {
        var list = Polymer.dom(this.root).querySelector("#status");
        var input = Polymer.dom(this.root).querySelector("#filterInput");

        if (parseInt(this.filterByChild) == 0) {
          input.setAttribute("style", "display: none;");
          list.setAttribute("style", "display: block;");
          this.selectedType = 'type';
        }
        else {
          list.setAttribute("style", "display: none;");
          input.setAttribute("style", "display: block;");
          //if (parseInt(this.filterByChild) == 1) {
          this.selectedType = 'lot';
          // }
          // else {
          //   this.selectedType = 'buyerdetails';
          // }
        }
      },


      _filterStatus(e) {
        if (parseInt(this.filterByStatus) == 1) {
          this.typeValue = "Buy";
        }
        else if (parseInt(this.filterByStatus) == 2) {
          this.typeValue = "Hold";
        }
        else if (parseInt(this.filterByStatus) == 3) {
          this.typeValue = "Reserve";
        }
        else {
          this.typeValue = "";
          if (this.applications == null) {
            //console.log(this.applications);
            var errormsg = Polymer.dom(this.root).querySelector("#errMsg");
            errormsg.setAttribute("style", "display: block;color:red; text-align:center");
          }
        }
      },

      iconForItem(item) {
        return item ? (item.integer < 50 ? 'my-icons:star-border' : 'my-icons:star') : '';
      },

      getClassForItem(item, selected) {
        // this.colorSelected = item.type;
        // console.log(this.colorSelected);
        return selected ? 'item expanded' : 'item';
      },

      toggleDrawer() {
        this.dispatchEvent(new CustomEvent('toggleDrawer', {
          bubbles: true, composed: true, detail: {
            narrow: this.$.narrow
          }
        }));
        this.$.narrow = !this.$.narrow;
      },

      loadMoreDat() {
        var self = this;
        var people = e.detail.response.results;
        people.forEach(function (element) {
          self.push('items', element);
        });

        asyncStuff(function done() {
          ironScrollTheshold.clearTriggers();
        });
      },

      _appsnew() {
        var node = Polymer.dom(this.root).querySelector("#appdetails");
        if (node) {
          var oldDiv = Polymer.dom(node.parentNode).querySelector("#d23");
          if (oldDiv) {
            Polymer.dom(node.parentNode).removeChild(oldDiv);
          }
          var newDiv = document.createElement("my-application-details");
          newDiv.setAttribute("id", "d23")
          // newDiv.setAttribute("block", "3")
          //if open existing
          var currentDiv = document.getElementById("appdetails");
          Polymer.dom(node.parentNode).insertBefore(newDiv, currentDiv);
        }
      }

    })

  </script>
</dom-module>