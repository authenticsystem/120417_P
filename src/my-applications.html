<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/iron-list/iron-list.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/iron-scroll-threshold/iron-scroll-threshold.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-search/paper-search-bar.html">
<link rel="import" href="my-icons.html">
<link rel="import" href="shared-styles.html">

<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="../bower_components/polymerfire/firebase-query.html">

<link rel="import" href="my-application-new.html">
<link rel="import" href="my-application-detail.html">
<link rel="import" href="my-application-edit.html">

<link rel="import" href="../bower_components/paper-radio-group/paper-radio-group.html">

<link rel="import" href="time-element.html">
<!-- <script src="../bower_components/time-elements/time-elements.js"></script> -->

<link rel="import" href="../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="my-application-card.html">

<dom-module id="my-applications">
  <template>
    <style include="shared-styles">
      :host {
        height: 100vh;
        margin: 0;

        display: flex;
        flex-direction: column;
      }

      .avatar {
        height: 40px;
        width: 40px;
        border-radius: 20px;
        box-sizing: border-box;
        background-color: #DDD;
      }

      .pad {
        padding: 0 16px;
        @apply --layout-flex;
        @apply --layout-vertical;
      }

      .primary {
        font-size: 18px;
        text-transform: capitalize;
      }

      .shortText,
      .longText {
        font-size: 12px;
      }

      .longText {
        color: gray;
        margin-bottom: -0.5em;
      }

      .spacer {
        @apply --layout-flex;
      }

      @media (max-width: 768px) {
        iron-list {
          margin: 16px;
          /* margin-top: 16px; */
          display: flex;
          height: 100vh;
          flex-direction: column;
          border-radius: 3px;
          /* box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2); */
        }
        paper-button {
          background: white;
        }
        paper-search-bar {
          margin: 15px;
          margin-top: 0;
          box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
        }
        .div1 {
          display: flex;
          flex-direction: column;
          margin: 15px auto;
          background: #ddd;
        }
      }

      @media (min-width: 768px) {
        iron-list {
          width: 765px;
          margin: 16px auto;
          /* margin-top: 16px; */
          height: 100vh;
          border-radius: 3px;
          /* box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2); */
        }
        .div1 {
          display: flex;
          width: 765px;
          margin: 15px auto;
          background: #ddd;
        }
        paper-search-bar {
          flex: 1;
          margin: 8px;
          box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
        }
        paper-button {
          background: white;
          flex: 1;
        }
      }

      app-header {
        color: rgb(255, 255, 255);
        background-color: #388E3C;
      }

      paper-fab.fab-menu {
        position: fixed;
        right: 32px;
        bottom: 32px;
      }

      paper-fab.fab-search {
        position: fixed;
        right: 40px;
        bottom: 104px;
      }

      paper-icon-button.menu {
        margin-right: 16px;
      }

      .item {
        @apply --layout-horizontal;
        /* padding: 20px; */
        background-color: white;
        border-bottom: 1px solid #ddd;
        cursor: pointer;
        margin-bottom: 10px;
        box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);

      }
    </style>

  

    <app-route route="{{route}}" pattern="" active="{{applicationActive}}"></app-route>
    <app-route route="{{route}}" pattern="/detail/:key" tail="{{detailRoute}}" data="{{detailData}}" active="{{detailActive}}"></app-route>
    <app-route route="{{route}}" pattern="/edit/:key" tail="{{editRoute}}" data="{{editData}}" active="{{editActive}}"></app-route>


    <!-- <app-route route="{{route}}" pattern="/:action" data="{{routeData}}" tail="{{subroute}}"></app-route> -->

    <div hidden$="{{!applicationActive}}">
      <!-- <template is="dom-if" if="{{_checkIfApplicationActive(applicationActive)}}"> -->
      <iron-pages selected="[[route.path]]" attr-for-selected="name" fallback-selection="view404" role="main">
        <div name="">
          <!-- <iron-ajax auto url="src/data.json" last-response="{{items}}"></iron-ajax> -->
          <app-header-layout fullbleed has-scrolling-region>
            <app-header fixed slot="header">
              <app-toolbar primary>
                <paper-icon-button class="menu" icon="my-icons:menu" drawer-toggle on-tap="toggleDrawer"></paper-icon-button>
                <div main-title>Applications</div>
              </app-toolbar>
            </app-header>

            <firebase-query id="query" path="/applications" data="{{applications}}" order-by-child="{{selectedType}}" start-at="{{typeValue}}"
              end-at="{{typeValue}}" limit-to-last="50">
            </firebase-query>

            <!-- on-lower-threshold="loadMoreData" -->
            <iron-scroll-threshold id="threshold">
              <div class="div1">
                <paper-menu-button>
                  <paper-button slot="dropdown-trigger" raised>
                    <iron-icon icon="check"></iron-icon>
                    <span style="text-transform:capitalize">{{selectedLabel}}</span>
                  </paper-button>
                  <paper-listbox style="cursor:pointer" slot="dropdown-content" selected="{{filterBy}}">
                    <paper-item style="display:none;">Filter By</paper-item>
                    <paper-item>By Reference</paper-item>
                    <paper-item>By Lot</paper-item>
                    <paper-item>By Type</paper-item>
                    <paper-item>By Buyer Lastname</paper-item>
                    <paper-item>By Agent Lastname</paper-item>
                  </paper-listbox>
                </paper-menu-button>
                <paper-search-bar query="{{search}}" disable-filter-button></paper-search-bar>
              </div>
              <!-- threshold -->
              <iron-list items="[[applications]]" as="item" selection-enabled multi-selection scroll-target="threshold">
                <div style="text-align:center">{{msg}}</div>
                <paper-toast id="toast" text="" duration="0"></paper-toast>
                <template>
                  <div class="divSeparator">
                    <div class$="[[getClassForItem(item, selected)]]" tabindex$="[[item.$key]]" style="width: 100%;">

                      <my-application-card item="{{item}}"></my-application-card>


                      <div tabindex="0">
                        <a href$="{{_getEditAppLink(item.$key)}}" tabindex="-1">
                          <paper-icon-button id="{{item.$key}}" noink on-tap="editDetails" data-args="{{item.$key}}" icon="my-icons:edit" alt="{{item.$key}}"
                            style="display:inline-block;position: absolute;  right: 48px; color: white; top:8px;"></paper-icon-button>
                          <paper-tooltip for="{{item.$key}}" position="bottom">edit</paper-tooltip>
                        </a>
                      </div>

                      <div tabindex="1">
                        <a href$="{{_getViewDetailsLink(item.$key)}}" tabindex="-1">
                          <paper-icon-button id="openDetailButton" noink on-tap="viewDetails" data-args="{{item.$key}}" icon="my-icons:open-in-new"
                            alt="{{item.$key}}" style="display:inline-block;position: absolute;  right: 8px; color: white; top:8px;"></paper-icon-button>
                          <paper-tooltip position="left">view details</paper-tooltip>
                        </a>
                      </div>



                    </div>

                  </div>


                </template>
              </iron-list>

            </iron-scroll-threshold>

          </app-header-layout>
          <a href="/applications/new" style="text-decoration: none;">
            <paper-fab noink class="fab-menu" on-tap="_appsnew" icon="my-icons:add"></paper-fab>
          </a>
        </div>

        <div name="/new">
          <div id="appnew"></div>
          <my-application-new id="d23" path="" prev-route="{{route.prefix}}"></my-application-new>
        </div>

        <div name="view404">Not found.</div>

      </iron-pages>
      <!-- </template> -->
    </div>

    <div hidden$="{{!detailActive}}">
      <!-- <template is="dom-if" if="{{_checkIfDetailActive(detailActive)}}"> -->
      <div id="appdetail"></div>
      <my-application-detail id="d24" transaction-key='{{detailData.key}}' prev-route="{{route.prefix}}"></my-application-detail>
      <!-- [[detailData.key]] -->
      <!-- </template> -->
    </div>

    <div hidden$="{{!editActive}}">
      <!-- <template is="dom-if" if="{{_checkIfEditActive(editActive)}}"> -->
      <div id="appedit"></div>
      <my-application-edit id="d25" transaction-key='{{editData.key}}' prev-route="{{route.prefix}}"></my-application-edit>
      <!-- </template> -->
    </div>

  </template>

  <script>
    Polymer({
      is: 'my-applications',

      properties: {
        items: {
          type: Array,
          value: function () {
            return [];
          }
        },
        narrow: {
          type: Boolean,
          notify: true
        },
        applications: {
          type: Object,
        },
        selectedType: {
          type: String,
          value: ''
        },
        filterBy: {
          type: Number,
          value: 2
        },
        selectedLabel: {
          type: String,
          value: 'By Lot'
        },
        search: {
          type: String,
          value: '',
        },
        route: Object,
        routeData: Object,
        // applicationActive: {
        //   type: Boolean,
        //   value: true
        // }

      },
      timeVoid(e){
        var time = Polymer.dom(this.root).querySelector("#start");
        var startTime = new Date(e);
        if(startTime == "Invalid Date"){
                this.timeElapse = "No data.";
              } else 
              {
                var endTime = new Date();
                // time difference in ms
                var timeDiff = endTime - startTime;
                // strip the miliseconds
                timeDiff /= 1000;
                // get seconds
                var seconds = Math.round(timeDiff % 60);
                // remove seconds from the date
                timeDiff = Math.floor(timeDiff / 60);
                // get minutes
                var minutes = Math.round(timeDiff % 60);
                // remove minutes from the date
                timeDiff = Math.floor(timeDiff / 60);
                // get hours
                var hours = Math.round(timeDiff % 24);
                // remove hours from the date
                timeDiff = Math.floor(timeDiff / 24);
                // the rest of timeDiff is number of days
                var days = timeDiff;
              
                if(days == 1){
                  this.timeElapse = days + " day ago";
                }
                if(days >= 2){
                  this.timeElapse = days + " days ago";
                }
                if(days == 0 && hours == 1){
                  this.timeElapse = "an hour ago";
                }
                if(days == 0 && hours >= 2){
                  this.timeElapse = hours + " hours ago";
                }
                if(days == 0 && minutes == 1){
                  this.timeElapse = "a minute ago";
                }
                if(days == 0 && minutes >= 2){
                  this.timeElapse = minutes + " minutes ago";
                }
                if(days == 0 && seconds == 1){
                  this.timeElapse = "a second ago";
                }
                if(days == 0 && seconds >= 2){
                  this.timeElapse = seconds + " seconds ago";
                }
              }
            // }, 1000);
      },

      // _checkIfApplicationActive(e) {
      //   // console.log('app'+e+this.applicationActive);
      //   return e;
      // },

      // _checkIfDetailActive(e) {
      //   // console.log('detail' + e);
      //   return e;
      // },

      // _checkIfEditActive(e) {
      //   // console.log('edit' + e);
      //   return e;
      // },

      toggleSearch() {
        var listStat = Polymer.dom(this.root).querySelector("#status");
        var input = Polymer.dom(this.root).querySelector("#filterInput");
        var list = Polymer.dom(this.root).querySelector("#child");
        if (list.style.display === "block") {
          listStat.style.display = "none";
          input.style.display = "none";
          list.style.display = "none";
        } else {
          list.style.display = "block";
        }
      },

      iconForItem(item) {
        return item ? (item.integer < 50 ? 'my-icons:star-border' : 'my-icons:star') : '';
      },

      getClassForItem(item, selected) {
        // this.colorSelected = item.type;
        // console.log(this.colorSelected);
        return selected ? 'item expanded' : 'item';
      },

      toggleDrawer() {
        this.dispatchEvent(new CustomEvent('toggleDrawer', {
          bubbles: true, composed: true, detail: {
            narrow: this.$.narrow
          }
        }));
        this.$.narrow = !this.$.narrow;
      },

      loadMoreDat() {
        var self = this;
        var people = e.detail.response.results;
        people.forEach(function (element) {
          self.push('items', element);
        });

        asyncStuff(function done() {
          ironScrollTheshold.clearTriggers();
        });
      },

      _appsnew() {
        var node = Polymer.dom(this.root).querySelector("#appnew");
        if (node) {
          var oldDiv = Polymer.dom(node.parentNode).querySelector("#d23");
          if (oldDiv) {
            Polymer.dom(node.parentNode).removeChild(oldDiv);
          }
          var newDiv = document.createElement("my-application-new");
          newDiv.setAttribute("id", "d23");
          newDiv.setAttribute("prev-route", this.route.prefix);
          // newDiv.setAttribute("block", "3")
          //if open existing
          var currentDiv = document.getElementById("appnew");
          Polymer.dom(node.parentNode).insertBefore(newDiv, currentDiv);
        }
      },

      _getViewDetailsLink(e) {
        return '/applications/detail/' + e.toString();
      },

      _getEditAppLink(e) {
        return '/applications/edit/' + e.toString();
      },

      viewDetails(e) {
        var data_args = Polymer.dom(e).rootTarget.getAttribute("alt");
        var node = Polymer.dom(this.root).querySelector("#appdetail");
        if (node) {
          var oldDiv = Polymer.dom(node.parentNode).querySelector("#d24");
          if (oldDiv) {
            Polymer.dom(node.parentNode).removeChild(oldDiv);
          }
          var newDiv = document.createElement("my-application-detail");
          newDiv.setAttribute("id", "d24")
          newDiv.setAttribute("transaction-key", data_args)
          newDiv.setAttribute("prev-route", this.route.prefix);
          //if open existing
          var currentDiv = document.getElementById("appdetail");
          Polymer.dom(node.parentNode).insertBefore(newDiv, currentDiv);

        }
      },

      editDetails(e) {
        var data_args = Polymer.dom(e).rootTarget.getAttribute("alt");
        var node = Polymer.dom(this.root).querySelector("#appedit");
        if (node) {
          var oldDiv = Polymer.dom(node.parentNode).querySelector("#d25");
          if (oldDiv) {
            Polymer.dom(node.parentNode).removeChild(oldDiv);
          }
          var newDiv = document.createElement("my-application-edit");
          newDiv.setAttribute("id", "d25")
          newDiv.setAttribute("transaction-key", data_args)
          newDiv.setAttribute("prev-route", this.route.prefix);
          //if open existing
          var currentDiv = document.getElementById("appedit");
          Polymer.dom(node.parentNode).insertBefore(newDiv, currentDiv);
        }
      }



    })

  </script>
</dom-module>