<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="shared-styles.html">


<dom-module id="my-announcement-edit">
    <template>
        <style include="shared-styles">
            :host {
                display: block;

                padding: 10px;
            }

            app-header {
                color: rgb(255, 255, 255);
                background-color: #388E3C;
            }

            paper-button {
                margin-top: 20px;
                height: 32px;
                font-size: 12px;
                font-weight: 400;
                width: 80px;
            }

            paper-button.submit {
                background-color: var(--paper-indigo-500);
                color: white;
            }

            .alertDanger {
                background-color: #ffdddd;
                border-left: 6px solid #f44336;
                padding: 4px 8px;
                display: none;
                font-size: 12px;
            }

            .row {
                display: -ms-flexbox;
                display: flex;
                -ms-flex-wrap: wrap;
                flex-wrap: wrap;
                padding: 0 4px;
            }

            .column {
                -ms-flex: 25%;
                /* IE10 */
                flex: 25%;
                max-width: 25%;
                padding: 0 4px;
            }

            .column img {
                margin-top: 8px;
                vertical-align: middle;
            }

            @media screen and (max-width: 800px) {
                .column {
                    -ms-flex: 50%;
                    flex: 50%;
                    max-width: 50%;
                }
            }

            @media screen and (max-width: 600px) {
                .column {
                    -ms-flex: 100%;
                    flex: 100%;
                    max-width: 100%;
                }
            }
        </style>

        <firebase-document path="{{path}}" data="{{newdata}}"></firebase-document>
        <firebase-query path="announcements/{{transactionKey}}/attachments" data="{{attachment}}"></firebase-query>
        <app-header-layout fullbleed has-scrolling-region>
            <app-header fixed slot="header">
                <app-toolbar primary>
                    <a href="/announcement">
                        <paper-icon-button noink class="menu" style="color: white;" icon="my-icons:arrow-back"></paper-icon-button>
                    </a>
                    <div main-title>Edit announcement</div>
                </app-toolbar>
            </app-header>
            <div class="card">
                <div class="alertDanger" id="alert">
                    <p>
                        {{alertMsg}}
                    </p>
                </div>
                <div>
                    <iron-form id="form1">
                        <form action="/foo" method="get">
                            <paper-input type="text" label="Title" value="{{title}}" required></paper-input>
                            <paper-textarea label="Message" value="{{message}}" required></paper-textarea>
                            <br>
                            <span>Attachments</span>
                            <br>
                            <div>
                                <div class="row">
                                    <template is="dom-repeat" items="[[attachment]]" as="file">
                                        <div class="column">
                                            <img src="[[file.url]]" style="width:100%"></img>
                                            <paper-button raised class="submit" alt="{{item}}" on-tap="_openDeleteDialog">delete</paper-button>
                                        </div>
                                    </template>
                                </div>
                            </div>
                            <br>
                            <paper-checkbox id="Owner">Owner</paper-checkbox>
                            <br>
                            <paper-checkbox id="Staff">Admin staff</paper-checkbox>
                            <br>
                            <paper-checkbox id="Manager">Manager</paper-checkbox>
                            <br>
                            <paper-checkbox id="Agent">Agent</paper-checkbox>
                            <br>
                            <paper-button raised class="submit" on-tap="_openSavingDialog">Update</paper-button>
                        </form>
                    </iron-form>
                </div>
            </div>

            <paper-dialog id="savingDialog">
                <h2>Update announcement?</h2>
                <div class="buttons">
                    <paper-button dialog-confirm autofocus on-tap="_updateAnnouncement">OK</paper-button>
                    <paper-button dialog-dismiss>Cancel</paper-button>
                </div>
            </paper-dialog>

            <paper-dialog id="deleteDialog">
                <h2>Delete this photo?</h2>
                <div class="buttons">
                    <paper-button dialog-confirm autofocus on-tap="_deletePhoto">OK</paper-button>
                    <paper-button dialog-dismiss>Cancel</paper-button>
                </div>
            </paper-dialog>

        </app-header-layout>
    </template>

    <script>
        Polymer({
            is: 'my-announcement-edit',
            properties: {
                myaccount: {
                    type: String
                },
                transactionKey: {
                    type: String,
                    observer: 'transactionKeyChanged'
                },
                newdata: {
                    type: Object,
                    observer: 'newdataChanged'
                },
            },

            toggleDrawer() {
                this.dispatchEvent(new CustomEvent('toggleDrawer', {
                    bubbles: true, composed: true, detail: {
                        narrow: this.$.narrow
                    }
                }));
                this.$.narrow = !this.$.narrow;
            },

            transactionKeyChanged() {
                this.getpath();
            },

            getpath() {
                if (this.transactionKey) {
                    this.path = 'announcements/' + this.transactionKey;
                }
                return this.path;
            },

            newdataChanged(e) {
                if (Object.keys(e).length > 0) {
                    this.title = e.title;
                    this.message = e.message;
                    if (e.agent == true) {
                        Polymer.dom(this.root).querySelector("#Agent").checked = true;
                    }
                    if (e.manager == true) {
                        Polymer.dom(this.root).querySelector("#Manager").checked = true;
                    }
                    if (e.owner == true) {
                        Polymer.dom(this.root).querySelector("#Owner").checked = true;
                    }
                    if (e.staff == true) {
                        Polymer.dom(this.root).querySelector("#Staff").checked = true;
                    }
                }
            },

            _openSavingDialog() {
                if (!this.title || !this.message) {
                    this.$.form1.submit();
                    Polymer.dom(this.root).querySelector("#alert").style.display = 'block';
                    this.alertMsg = 'Please fill-up the required field.';
                }
                else {
                    this.$.savingDialog.open();
                }
            },

            _updateAnnouncement() {
                var boxStaff = Polymer.dom(this.root).querySelector("#Staff");
                var boxManager = Polymer.dom(this.root).querySelector("#Manager");
                var boxAgent = Polymer.dom(this.root).querySelector("#Agent");
                var boxOwner = Polymer.dom(this.root).querySelector("#Owner");
                var staff = false;
                var manager = false;
                var agent = false;
                var owner = false;

                if (boxStaff.checked == true) {
                    staff = true;
                }
                if (boxManager.checked == true) {
                    manager = true;
                }
                if (boxAgent.checked == true) {
                    agent = true;
                }
                if (boxOwner.checked == true) {
                    owner = true;
                }

                var ref = firebase.database().ref("/announcements");
                ref.child(this.transactionKey).update({
                    staff: staff,
                    manager: manager,
                    agent: agent,
                    owner: owner,
                    title: this.title,
                    message: this.message,
                    photo: firebase.auth().currentUser.photoURL,
                    timestamp: { ".sv": "timestamp" },
                    sender: this.myaccount,
                    isupdated: true
                });

                this.notification(staff, manager, agent, owner, this.title, );
                window.location = "/announcement";
            },

            notification(staff, manager, agent, owner, announcementTitle) {
                var ref = firebase.database().ref("notifications");
                ref.push({
                    title: announcementTitle,
                    click: "/dashboard",
                    message: "updating announcement",
                    photo: firebase.auth().currentUser.photoURL,
                    isread: false,
                    recipient: {
                        staff: staff,
                        manager: manager,
                        agent: agent,
                        owner: owner,
                        recipient_accountCode: ''
                    },
                    sender: this.myaccount,
                    timestamp: { ".sv": "timestamp" },
                    source: 'announcement',
                });
            },

            _openDeleteDialog(e) {
                var transkey = Polymer.dom(e).rootTarget.getAttribute("alt");
                // var photoKey = Polymer.dom(e).rootTarget.getAttribute("photokey");
                var data = JSON.parse(transkey);
                this.$.deleteDialog.open();
                // this.photoKey = photoKey;
                console.log(data);
            },

            _deletePhoto() {
                var desertRef = firebase.storage().ref('attachments/' + this.urlPhoto);
                // Delete the file
                desertRef.delete().then(function () {
                    // File deleted successfully
                    var ref = firebase.database().ref("announcements/" + this.transactionKey + "/attachments" + this.photoKey).remove();
                    window.location = "announcement/edit/" + this.transactionKey;
                }).catch(function (error) {
                    // Uh-oh, an error occurred!
                });
            }
        })
    </script>
</dom-module>