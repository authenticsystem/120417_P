<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="shared-styles.html">


<dom-module id="my-announcement-edit">
    <template>
        <style include="shared-styles">
            :host {
                display: block;

                padding: 10px;
            }

            app-header {
                color: rgb(255, 255, 255);
                background-color: #388E3C;
            }

            .action {
                padding-top: 16px;
            }

            paper-button {
                height: 32px;
                font-size: 12px;
                font-weight: 400;
                width: 80px;
            }

            paper-button.green {
                background-color: var(--paper-green-500);
                color: white;
            }
        </style>

        <firebase-document path="{{path}}" data="{{newdata}}"></firebase-document>
        <app-header-layout fullbleed has-scrolling-region>
            <app-header fixed slot="header">
                <app-toolbar primary>
                    <a href="/announcement">
                        <paper-icon-button noink class="menu" style="color: white;" icon="my-icons:arrow-back"></paper-icon-button>
                    </a>
                    <div main-title>Edit announcement</div>
                </app-toolbar>
            </app-header>
            <div style="padding:16px">
                <div class="card">
                    <span style="color:red; font-size:13px; float:right">{{msg}}</span>
                    <paper-input required auto-validate label="Title" value="{{title}}"></paper-input>
                    <paper-textarea required auto-validate label="Message" value="{{message}}"></paper-textarea>
                    <paper-checkbox id="Staff">Admin staff</paper-checkbox>
                    <paper-checkbox id="Manager">Manager</paper-checkbox>
                    <paper-checkbox id="Agent">Agent</paper-checkbox>
                    <paper-checkbox id="Owner">Owner</paper-checkbox>
                    <div class="action">
                        <paper-button on-tap="_openSavingDialog" id="next" raised class="green">Save</paper-button>
                    </div>
                </div>
            </div>
            <paper-dialog id="savingDialog">
                <p>Update announcement?</p>
                <div class="buttons">
                    <paper-button dialog-dismiss>Cancel</paper-button>
                    <paper-button dialog-confirm autofocus on-tap="_announce">OK</paper-button>
                </div>
            </paper-dialog>

        </app-header-layout>
    </template>

    <script>
        Polymer({
            is: 'my-announcement-edit',
            properties: {
                myaccount: {
                    type: String
                },
                transactionKey: {
                    type: String,
                    observer: 'transactionKeyChanged'
                },
                newdata: {
                    type: Object,
                    observer: 'newdataChanged'
                },
            },

            toggleDrawer() {
                this.dispatchEvent(new CustomEvent('toggleDrawer', {
                    bubbles: true, composed: true, detail: {
                        narrow: this.$.narrow
                    }
                }));
                this.$.narrow = !this.$.narrow;
            },

            transactionKeyChanged() {
                this.getpath();
            },

            getpath() {
                if (this.transactionKey) {
                    this.path = 'announcements/' + this.transactionKey;
                }
                return this.path;
            },

            newdataChanged(e) {
                if (Object.keys(e).length > 0) {
                    this.title = e.title;
                    this.message = e.message;
                    if (e.agent == true) {
                        Polymer.dom(this.root).querySelector("#Agent").checked = true;
                    }
                    if (e.manager == true) {
                        Polymer.dom(this.root).querySelector("#Manager").checked = true;
                    }
                    if (e.owner == true) {
                        Polymer.dom(this.root).querySelector("#Owner").checked = true;
                    }
                    if (e.staff == true) {
                        Polymer.dom(this.root).querySelector("#Staff").checked = true;
                    }
                }
            },

            _openSavingDialog() {
                if (!this.title || !this.message) {
                    this.msg = 'Please fill-up the required field.';
                }
                else {
                    this.$.savingDialog.open();
                }
            },

            _announce() {
                var boxStaff = Polymer.dom(this.root).querySelector("#Staff");
                var boxManager = Polymer.dom(this.root).querySelector("#Manager");
                var boxAgent = Polymer.dom(this.root).querySelector("#Agent");
                var boxOwner = Polymer.dom(this.root).querySelector("#Owner");
                var staff = false;
                var manager = false;
                var agent = false;
                var owner = false;

                if (boxStaff.checked == true) {
                    staff = true;
                }
                if (boxManager.checked == true) {
                    manager = true;
                }
                if (boxAgent.checked == true) {
                    agent = true;
                }
                if (boxOwner.checked == true) {
                    owner = true;
                }
                
                var ref = firebase.database().ref("/announcements");
                ref.child(this.transactionKey).update({
                    staff: staff,
                    manager: manager,
                    agent: agent,
                    owner: owner,
                    title: this.title,
                    message: this.message,
                    photo: firebase.auth().currentUser.photoURL,
                    timestamp: { ".sv": "timestamp" },
                    sender: this.myaccount,
                    isupdated: true
                });
                this.notification(staff, manager, agent, owner, this.title, );
                window.location = "/announcement";
            },

            notification(staff, manager, agent, owner, announcementTitle) {
                var ref = firebase.database().ref("notifications");
                ref.push({
                    title: announcementTitle,
                    click: "/dashboard",
                    message: "updating announcement",
                    photo: firebase.auth().currentUser.photoURL,
                    isread: false,
                    recipient: {
                        staff: staff,
                        manager: manager,
                        agent: agent,
                        owner: owner,
                        recipient_accountCode: ''
                    },
                    sender: this.myaccount,
                    timestamp: { ".sv": "timestamp" },
                    source: 'announcement',
                });
            }
        })
    </script>
</dom-module>