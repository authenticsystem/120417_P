<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/neon-animation/neon-animated-pages.html">
<link rel="import" href="../bower_components/neon-animation/neon-animatable.html">
<link rel="import" href="../bower_components/neon-animation/neon-animations.html">
<link rel="import" href="../bower_components/neon-animation/neon-animation-behavior.html">
<link rel="import" href="../bower_components/neon-animation/web-animations.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="../bower_components/polymerfire/firebase-query.html">

<link rel="import" href="my-icons.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="short-unique-id.html">

<dom-module id="my-briefcase-new">
    <template>
        <style include="shared-styles">
            :host {
                display: block;
            }

            app-header {
                color: rgb(255, 255, 255);
                background-color: #388E3C;
            }

            app-drawer-layout:not([narrow]) [drawer-toggle] {
                display: none;
            }

            app-drawer {
                --app-drawer-content-container: {
                    background-color: #F4F5F6;
                }
            }

            .mnu {
                padding: 16px;
            }

            paper-fab {
                background-color: #1976d2;
            }

            @media (min-width: 800px) {
                .footer {
                    position: absolute;
                    bottom: 16px;
                    width: 100%;
                }

                #favBack {
                    position: absolute;
                    left: 48px;
                    bottom: 48px;
                }

                #favNext {
                    position: absolute;
                    right: 48px;
                    bottom: 48px;
                }
            }

            @media (max-width: 800px) {
                #favBack {
                    position: absolute;
                    left: 16px;
                    bottom: 48px;
                }

                #favNext {
                    position: absolute;
                    right: 16px;
                    bottom: 48px;
                }
            }

            .listbox {
                border: 1px solid #ccc;
                margin-top: 16px;
            }

            paper-item {
                font-size: 12px;
                cursor: pointer;
            }

            paper-button {
                height: 32px;
                font-size: 12px;
                font-weight: 400;
                background-color: #1976d2;
                color: white;
            }
        </style>

        <app-drawer-layout fullbleed narrow="{{narrow}}" id="drawerLayout">
            <app-drawer id="drawer" slot="drawer" swipe-open="[[narrow]]" align="right">
                <div class="mnu" role="listbox">
                    <paper-item id="lotdetails">
                        <div class="circle-mini-first">1</div>
                        <span>Lot Details</span>
                    </paper-item>

                    <paper-item id="buyersinformation">
                        <div class="circle-mini">2</div>
                        <span>Buyer's Information</span>
                    </paper-item>

                    <paper-item id="finalize">
                        <div class="circle-mini">3</div>
                        <span>Finalize</span>
                    </paper-item>

                    <paper-item id="complete">
                        <div class="circle-mini-last">4</div>
                        <span>Complete</span>
                    </paper-item>
                </div>
            </app-drawer>

            <app-header-layout fullbleed has-scrolling-region>
                <app-header fixed slot="header">
                    <app-toolbar primary>
                        <a href="/briefcase">
                            <paper-icon-button noink class="menu" style="color: white;" icon="my-icons:arrow-back"></paper-icon-button>
                        </a>
                        <div main-title>New Briefcase</div>
                        <paper-icon-button drawer-toggle icon="my-icons:menu"></paper-icon-button>
                    </app-toolbar>
                </app-header>

                <neon-animated-pages selected="{{selectedPage}}" entry-animation="{{entryanimation}}" exit-animation="{{exitanimation}}">
                    <neon-animatable>
                        <firebase-document id="fullLotQuery" path="/lots/{{fullLot}}" data="{{fullLotData}}"></firebase-document>
                        <div style="padding: 16px">
                            <paper-card style="width: 100%">
                                <div class="card-content">
                                    <div class="docu-header">1. Lot Details</div>
                                    <div class="docu-content">
                                        <div style="display: flex">
                                            <paper-input always-float-label label="Block" value="{{block}}" style="margin-right: 8px"></paper-input>
                                            <paper-input always-float-label label="Lot" value="{{lot}}" style="margin-right: 8px"></paper-input>
                                            <paper-input always-float-label label="Level" value="{{level}}"></paper-input>
                                        </div>
                                    </div>

                                    <template is="dom-if" if="{{fulllotCard}}">
                                        <paper-card style="width: 100%">
                                            <template is="dom-if" if="{{noRecord}}">
                                                <div class="card-content">
                                                    <div style="text-align: center">No record found..</div>
                                                </div>
                                            </template>

                                            <template is="dom-if" if="{{!noRecord}}">
                                                <div style$="padding:16px; background-color: {{fullLotData.maprenderdetails.type_bg_color}}; color:{{fullLotData.maprenderdetails.type_fore_color}}">
                                                    <span style$="padding: 4px; background-color:{{fullLotData.maprenderdetails.bg_color}}; color:{{fullLotData.maprenderdetails.fore_color}}">
                                                        {{fullLotData.maprenderdetails.status_name}}
                                                    </span><br>
                                                    <div style="font-size: 24px;">{{_formatLot(fullLotData.block,
                                                        fullLotData.lot,
                                                        fullLotData.level)}}
                                                    </div>
                                                    <div style="font-size: 12px">{{fullLotData.maprenderdetails.type_name}}
                                                        - {{fullLotData.area}} - {{fullLotData.designation}}</div>
                                                </div>
                                            </template>
                                        </paper-card>
                                    </template>
                                </div>
                            </paper-card>
                        </div>
                    </neon-animatable>
                    <neon-animatable>
                        <firebase-query path="buyers" order-by-child="cellphone" equal-to="{{cellphoneNum}}"
                            limit-to-first="1" data="{{buyersData}}"></firebase-query>
                        <div style="padding: 16px">
                            <paper-card style="width: 100%">
                                <div class="card-content">
                                    <div class="docu-header">2. Buyer's Information <span style="float: right; color: red; font-size: 12px; font-weight:300">'*' required field</span></div>
                                    <div class="docu-content">
                                        <paper-input label="Cellphone*" always-float-label value="{{cellphoneNum}}"></paper-input>
                                        <paper-input label="Firstname*" always-float-label value="{{firstname}}"></paper-input>
                                        <paper-input label="Middlename*" always-float-label value="{{middlename}}"></paper-input>
                                        <paper-input label="Lastname*" always-float-label value="{{lastname}}"></paper-input>
                                        <paper-input label="Suffix" always-float-label value="{{suffix}}"></paper-input>
                                        <paper-input label="email" always-float-label value="{{email}}"></paper-input>
                                    </div>
                                </div>
                            </paper-card>
                        </div>
                    </neon-animatable>
                    <neon-animatable>
                        <div style="padding: 16px">
                            <paper-card style="width: 100%">
                                <div class="card-content">
                                    <div class="docu-header">3. Finalize</div>
                                    <div class="docu-content">
                                        <paper-card style="width: 100%">
                                            <div style$="padding:16px; background-color: {{fullLotData.maprenderdetails.type_bg_color}}; color:{{fullLotData.maprenderdetails.type_fore_color}}">
                                                <span style$="padding: 4px; background-color:{{fullLotData.maprenderdetails.bg_color}}; color:{{fullLotData.maprenderdetails.fore_color}}">
                                                    {{fullLotData.maprenderdetails.status_name}}
                                                </span><br>
                                                <div style="font-size: 24px;">{{_formatLot(fullLotData.block,
                                                    fullLotData.lot,
                                                    fullLotData.level)}}
                                                </div>
                                                <div style="font-size: 12px">{{fullLotData.maprenderdetails.type_name}}
                                                    -
                                                    {{fullLotData.area}} - {{fullLotData.designation}}</div>
                                            </div>
                                            <div class="card-content">
                                                <div style="color: gray">Buyer's Details</div>
                                                <div>
                                                    <table>
                                                        <tr>
                                                            <td style="font-size: 12px">Name:</td>
                                                            <td>{{_formatName(firstname, middlename, lastname,
                                                                suffix)}}</td>
                                                        </tr>
                                                        <tr>
                                                            <td style="font-size: 12px">Cellphone:</td>
                                                            <td>{{_check(cellphoneNum)}}</td>
                                                        </tr>
                                                        <tr>
                                                            <td style="font-size: 12px">Email:</td>
                                                            <td>{{_check(email)}}</td>
                                                        </tr>
                                                    </table>
                                                </div>
                                                <div style="color: gray">Agent's Details</div>
                                                <div>
                                                    <table>
                                                        <tr>
                                                            <td style="font-size: 12px">Name:</td>
                                                            <td>{{_formatName(agent_firstname, agent_middlename,
                                                                agent_lastname,
                                                                agent_suffix)}}
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td style="font-size: 12px">Cellphone:</td>
                                                            <td>{{_check(agent_cellphoneNum)}}</td>
                                                        </tr>
                                                        <tr>
                                                            <td style="font-size: 12px">Email:</td>
                                                            <td>{{_check(agent_email)}}</td>
                                                        </tr>
                                                    </table>
                                                </div>
                                            </div>
                                        </paper-card>
                                    </div>
                                </div>
                            </paper-card>
                        </div>
                    </neon-animatable>
                    <neon-animatable>
                        <div style="padding: 16px">
                            <paper-card style="width: 100%">
                                <div class="card-content">
                                    <div class="docu-header">4. Complete</div>
                                    <div class="docu-content">
                                        <div style="text-align:center; color: green" id="msg">{{MSG}} <span style="font-weight: bold">"{{briefcaseRef}}"</span></div>
                                    </div>
                                </div>
                            </paper-card>
                        </div>
                    </neon-animatable>
                </neon-animated-pages>

            </app-header-layout>

            <div class="footer">
                <template is="dom-if" if="{{back}}">
                    <paper-fab id="favBack" icon="my-icons:chevron-left" on-tap="_back"></paper-fab>
                </template>
                <template is="dom-if" if="{{next}}">
                    <paper-fab id="favNext" icon="my-icons:chevron-right" on-tap="_next"></paper-fab>
                </template>
            </div>

        </app-drawer-layout>

    </template>
    <script>
        Polymer({
            is: 'my-briefcase-new',

            properties: {
                account: Object,
                selectedPage: {
                    type: Number,
                    value: 0
                },
                back: {
                    type: Boolean,
                    value: false
                },
                next: {
                    type: Boolean,
                    value: false
                },
                fullLotData: Object,
            },

            observers: [
                '_accountChanged(account)',
                '_blocklotlevelChanged(block, lot, level)',
                '_fullLotDataChanged(fullLotData.*)',
                '_buyersDataChanged(buyersData)',
                '_selectedPageChanged(selectedPage, fullLotData, cellphoneNum, firstname, middlename, lastname)'
            ],

            guid() {
                var uid = new ShortUniqueId();
                return uid.randomUUID(6);
            },

            _accountChanged(e) {
                if (e.length > 0) {
                    this.agentKey = e[0].accountkey;
                    this.agent_firstname = e[0].name.firstname;
                    this.agent_middlename = e[0].name.middlename;
                    this.agent_lastname = e[0].name.lastname;
                    this.agent_suffix = e[0].name.suffix;
                    this.agent_cellphoneNum = e[0].cellphone;
                    this.agent_email = e[0].email;
                }
            },

            _blocklotlevelChanged(block, lot, level) {
                if (block || lot || level) { this.fulllotCard = true; }
                else { this.fulllotCard = false; }

                if (block) { this.block = block.toString().toUpperCase(); }
                if (lot) { this.lot = lot.toString().toUpperCase(); }
                if (level) { this.level = level.toString().toLowerCase(); }

                this.fullLot = "block" + this.block + "lot" + this.lot + (this.level ? "level" + this.level : "");
            },

            _fullLotDataChanged() {
                if (this.fullLotData) {
                    if (this.fullLotData.lot) {
                        this.noRecord = false;
                    } else {
                        this.noRecord = true;
                    }
                }
            },

            _buyersDataChanged(e) {
                if (e.length > 0) {
                    this.buyerKey = e[0].$key;
                    this.firstname = e[0].firstname;
                    this.middlename = e[0].middlename;
                    this.lastname = e[0].lastname;
                    this.suffix = e[0].suffix;
                    this.email = e[0].email;
                }
            },

            _selectedPageChanged() {
                if (this.selectedPage === 0) {
                    this.back = false;
                    if (this.fullLotData.type_status_inventoriable === this.fullLotData.type + '_' + this.fullLotData.status + '_' + this.fullLotData.inventoriable && this.fullLotData.inventoriable === 'yes' && this.fullLotData.status === 'available') {
                        this.next = true;
                    } else {
                        this.next = false;
                    }
                } else if (this.selectedPage === 1) {
                    this.back = true;
                    if (this.cellphoneNum && this.firstname && this.middlename && this.lastname) {
                        this.next = true;
                    } else {
                        this.next = false;
                    }
                    Polymer.dom(this.root).querySelector('#favNext').style.backgroundColor = '#1976d2';
                    Polymer.dom(this.root).querySelector('#favNext').icon = "my-icons:chevron-right";
                } else if (this.selectedPage === 2) {
                    this.back = true;
                    this.next = true;
                    Polymer.dom(this.root).querySelector('#favNext').style.backgroundColor = 'green';
                    Polymer.dom(this.root).querySelector('#favNext').icon = "my-icons:done";
                } else {
                    this.back = false;
                    this.next = false;
                }
            },

            _back() {
                this.entryanimation = "slide-from-left-animation";
                this.exitanimation = "slide-right-animation";
                this.selectedPage = (parseInt(this.selectedPage) - 1);

                if (this.selectedPage === 0) {
                    this.back = false;
                    if (this.fullLotData.type_status_inventoriable === this.fullLotData.type + '_' + this.fullLotData.status + '_' + this.fullLotData.inventoriable && this.fullLotData.inventoriable === 'yes' && this.fullLotData.status === 'available') {
                        this.next = true;
                    } else {
                        this.next = false;
                    }
                }
            },

            _next() {
                this.entryanimation = "slide-from-right-animation";
                this.exitanimation = "slide-left-animation";
                this.selectedPage = (parseInt(this.selectedPage) + 1);

                if (this.selectedPage === 3) {

                    var ddate = new Date();
                    var startDateTimeValue = ddate.getFullYear() + "-" + ("0" + (ddate.getMonth() + 1)).slice(-2) + "-" + ("0" + ddate.getDate()).slice(-2)
                        + "T" + ("0" + (ddate.getHours())).slice(-2) + ":" + ("0" + ddate.getMinutes()).slice(-2);


                    this.buyerKey = this.buyerKey ? this.buyerKey : this.guid();

                    var buyerdetails = {
                        firstname: this.firstname,
                        middlename: this.middlename,
                        lastname: this.lastname,
                        suffix: this.suffix,
                        cellphone: this.cellphoneNum,
                        email: this.email
                    }

                    var agentdetails = {
                        firstname: this.agent_firstname,
                        middlename: this.agent_middlename,
                        lastname: this.agent_lastname,
                        suffix: this.agent_suffix,
                        cellphone: this.agent_cellphoneNum,
                        email: this.agent_email
                    }

                    var data = {
                        buyer: this.buyerKey,
                        buyerdetails: buyerdetails,
                        agent: this.agentKey,
                        agentdetails: agentdetails,
                        lot: 'block' + this.fullLotData.block + 'lot' + this.fullLotData.lot + (this.fullLotData.level ? 'level' + this.fullLotData.level : ''),
                        lotdetails: this.fullLotData,
                        reference: this.guid(),
                        type: 'Hold',
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        start: startDateTimeValue,
                        briefcasedetails: {
                            status: 'Draft',
                            dateCreated: startDateTimeValue,
                            isUpdated: false
                        }
                    }

                    var newPostKey = firebase.database().ref().child('briefcaseDraft').push().key;

                    var updatesData = {};
                    updatesData['/briefcaseDraft/' + this.agentKey + '/' + newPostKey] = data;
                    if (this.buyerKey) {
                        updatesData["/buyers/" + this.buyerKey] = buyerdetails;
                    } else {
                        this.MSG = 'No Buyer key';
                    }
                    firebase.database().ref().update(updatesData);
                    this.MSG = 'Application saved successfully as a draft with a reference key';
                    this.briefcaseRef = data.reference;
                }
            },

            _formatLot(block, lot, level) {
                if (level) return "Block " + block + " Lot " + lot + " Level " + level;
                else return "Block " + block + " Lot " + lot;
            },

            _formatName(fname, mname, lname, suffix) {
                if (suffix) return fname + ' ' + mname + ' ' + lname + ' ' + suffix;
                else return fname + ' ' + mname + ' ' + lname;
            },

            _check(e) {
                if (e) return e;
                else return 'none';
            },
        })
    </script>
</dom-module>