<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/neon-animation/web-animations.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">

<link rel="import" href="shared-styles.html">
<link rel="import" href="short-unique-id.html">

<dom-module id="my-accountlist-new">
    <template>
        <style include="shared-styles">
            :host {
                display: block;

                padding: 10px;
            }

            app-header {
                color: rgb(255, 255, 255);
                background-color: #388E3C;
            }

            @media screen and (max-width: 800px) {
                .nameInput {
                    width: 100%;
                }
            }

            @media screen and (min-width: 800px) {
                .nameInput {
                    width: 24%;
                    display: inline-block;
                }
            }

            .container {
                background-color: white;
                padding: 16px;
                box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
            }

            paper-button {
                height: 32px;
                font-size: 12px;
                font-weight: 400;
                width: 80px;
            }

            paper-button.submit {
                background-color: var(--paper-indigo-500);
                color: white;
            }

            paper-checkbox {
                margin-right: 5px;
            }
        </style>

        <app-header-layout fullbleed has-scrolling-region>
            <app-header fixed slot="header">
                <app-toolbar primary>
                    <a id="href" href="/accountlist" style="color: white">
                        <paper-icon-button class="menu" icon="my-icons:arrow-back"></paper-icon-button>
                    </a>
                    <div main-title>New Account</div>
                </app-toolbar>
            </app-header>

            <div class="container" style="margin: 16px;">
                <iron-form id="accountlistForm">
                    <form>
                        <span style="color:red; font-size:13px; float:right">{{msg}}</span>

                        <paper-input readonly value="{{accountkey}}" always-float-label label="Account Key" required></paper-input>
                        <paper-input value="{{firstname}}" always-float-label label="First Name" class="nameInput"
                            required></paper-input>
                        <paper-input value="{{middlename}}" always-float-label label="Middle Name" class="nameInput"
                            required></paper-input>
                        <paper-input value="{{lastname}}" always-float-label label="Last Name" class="nameInput"
                            required></paper-input>
                        <paper-input value="{{suffix}}" always-float-label label="Suffix" class="nameInput"></paper-input>
                        <paper-input value="{{email}}" always-float-label label="Email" required></paper-input>
                        <paper-input required allowed-pattern="[\d]" prevent-invalid-input char-counter maxlength="10"
                            value="{{cellphone}}" always-float-label label="Cellphone num.">
                            <div slot="prefix">+63</div>
                        </paper-input>
                        <paper-input label="Position" value="{{position}}" required></paper-input>

                        <div style="font-size:12px; margin-top:10px;">Access</div>
                        <paper-checkbox checked="{{dashboard}}">Dashboard</paper-checkbox>
                        <paper-checkbox checked="{{applications}}">Applications</paper-checkbox>
                        <paper-checkbox checked="{{accountlist}}">Accountlist</paper-checkbox>
                        <paper-checkbox checked="{{briefcase}}">Briefcase</paper-checkbox>
                        <paper-checkbox checked="{{announcement}}">Announcement</paper-checkbox>
                        <paper-checkbox checked="{{group}}">Group</paper-checkbox>

                        <template is="dom-if" if="{{dashboard}}">
                            <div>
                                <div style="font-size:12px; margin-top:10px;">Reports</div>
                                <paper-checkbox checked="{{sales}}">Owner</paper-checkbox>
                                <paper-checkbox checked="{{staff}}">Staff</paper-checkbox>
                                <paper-checkbox checked="{{salesAgent}}">Agent</paper-checkbox>
                            </div>
                        </template>

                        <template is="dom-if" if="{{salesAgent}}">
                            <div>
                                <div style="font-size:12px; margin-top:10px;">Agent Reports</div>
                                <paper-checkbox checked="{{agentstype}}">Agents Type</paper-checkbox>
                                <paper-checkbox checked="{{agentsgroup}}">Agents Group</paper-checkbox>
                                <paper-checkbox checked="{{agents}}">All Agents</paper-checkbox>
                            </div>
                            <div>
                                <paper-dropdown-menu label="Type" required>
                                    <paper-listbox slot="dropdown-content" attr-for-selected="value" selected="{{selectedType}}">
                                        <paper-item value="inhouse">In-House</paper-item>
                                        <paper-item value="broker">Broker</paper-item>
                                        <paper-item value="corporate">Corporate</paper-item>
                                    </paper-listbox>
                                </paper-dropdown-menu>
                                <paper-dropdown-menu label="Group" required>
                                    <paper-listbox slot="dropdown-content" attr-for-selected="value" selected="{{selectedGroup}}">
                                        <firebase-query path="/group/{{selectedType}}" data="{{groupData}}"></firebase-query>
                                        <template is="dom-repeat" items="[[groupData]]">
                                            <paper-item value="[[item.groupID]]">[[item.name]]</paper-item>
                                        </template>
                                    </paper-listbox>
                                </paper-dropdown-menu>
                                <!-- <paper-dropdown-menu label="Designation" vertical-align="top" horizontal-align="left" vertical-offset="60">
                                <paper-listbox slot="dropdown-content" attr-for-selected="value" selected="{{designation}}">
                                    <paper-item value="Team Leader">Team Leader</paper-item>
                                    <paper-item value="Member">Member</paper-item>
                                </paper-listbox>
                            </paper-dropdown-menu> -->
                            </div>
                        </template>

                    </form>
                </iron-form>

                <div style="margin-top: 16px">
                    <paper-button id="submitBTN" class="submit" on-tap="_submit">Add</paper-button>
                </div>
            </div>

            <paper-dialog id="successDialog" no-cancel-on-outside-click>
                <div style="text-align: center;">
                    <h3>New account added successfully!</h3>
                </div>
                <div class="buttons">
                    <paper-button dialog-dismiss on-tap="_successDone">OK</paper-button>
                </div>
            </paper-dialog>

            <!-- <div style="margin: auto; border: 5px dotted #bbb;" hidden$="{{acctSecondStep}}">
                <paper-card>
                    <div id="printMe" class="card-content">
                        <div>Account No.
                            <span style="font-family: Courier New; font-size: 20px">
                                <strong>{{accountkey}}</strong>
                            </span>
                        </div>
                        <div>Name: {{firstname}} {{middlename}} {{lastname}} {{suffix}}</div>
                        <div>Contact No. +63{{cellphone}}</div>
                        <div>Position: {{position}}</div>
                        <div>Type: {{type}}</div>
                        <div>Group: {{group}}</div>
                        <div>Designation: {{designation}}</div>
                        <br>
                        <div>
                            <strong>To login to Haven of Peace, Please follow instructions below.</strong>
                        </div>
                        <div>Step 1. Create an account to Haven of Peace under more options</div>
                        <div>Step 2. Verify Email, click the link that was sent to your email account.</div>
                        <div>Step 3. Enter the account number above to link your Haven of Peace account.</div>
                        <div>Step 4. Enter the account code that was sent to your phone number provided above to complete
                            the login procedure.</div>
                    </div>
                    <div class="card-actions">
                        <paper-button on-tap="_print">
                            <iron-icon icon="my-icons:print"></iron-icon> Print
                        </paper-button>
                    </div>
                </paper-card>
            </div> -->
        </app-header-layout>
    </template>

    <script>
        Polymer({
            is: 'my-accountlist-new',
            properties: {
                // role: String,
                // typeHide: Boolean,
                // acctFirstStep: Boolean,
                // acctSecondStep: Boolean,
                // hideAgentReports: {
                //     type: Boolean,
                //     value: true
                // },
                msg: {
                    type: String,
                    value: ''
                }
            },
            observers: [
                '_salesAgentChanged(salesAgent)',
                '_dashboardChanged(dashboard)'
            ],

            _salesAgentChanged(e) {
                if (e === false) {
                    this.agentstype = false;
                    this.agentsgroup = false;
                    this.agents = false;

                    this.selectedType = '';
                    this.selectedGroup = '';
                }
            },

            _dashboardChanged(e) {
                if (e === false) {
                    this.sales = false;
                    this.staff = false;
                    this.salesAgent = false;
                }
            },

            ready() {
                this.accountkey = this.guid();
                // this.typeHide = true;
                // this.groupHide = true;
                // this.designationHide = true;

                // this.acctFirstStep = false;
                // this.acctSecondStep = true;
            },

            guid() {
                var uid = new ShortUniqueId();
                return uid.randomUUID(6);
            },

            _submit() {
                var submitBTN = Polymer.dom(this.root).querySelector('#submitBTN');
                var accountlistForm = Polymer.dom(this.root).querySelector('#accountlistForm');

                accountlistForm.submit();
                submitBTN.disabled = true;

                if (this.firstname && this.middlename && this.lastname && this.email && this.cellphone && this.position) {
                    if (this.cellphone.length != 10) {
                        this.msg = 'Error! Invalid cellphone number...';
                        submitBTN.disabled = false;
                    } else if (this.salesAgent === true) {
                        if (this.selectedType && this.selectedGroup) {
                            this.msg = null;
                            submitBTN.disabled = false;

                            var data = {
                                accountkey: this.accountkey,
                                active: true,
                                name: {
                                    firstname: this.firstname,
                                    middlename: this.middlename,
                                    lastname: this.lastname,
                                    suffix: this.suffix ? this.suffix : ''
                                },
                                email: this.email,
                                cellphone: this.cellphone,
                                position: this.position,
                                access: {
                                    accountlist: this.accountlist,
                                    announcement: this.announcement,
                                    applications: this.applications,
                                    briefcase: this.briefcase,
                                    dashboard: this.dashboard,
                                    groups: this.group
                                },
                                type: this.selectedType,
                                group: this.selectedGroup,
                                type_group: this.selectedType + '_' + this.selectedGroup,
                                reports: {
                                    salesChart: this.sales,
                                    staffChart: this.staff,
                                    salesAgentChart: this.salesAgent,
                                    salesAgentReport: {
                                        agentsChart: this.agents,
                                        agentstypeChart: this.agentstype,
                                        agentsgroupChart: this.agentsgroup
                                    }
                                }
                            };
                            this._finish(data);
                        } else {
                            this.msg = null;
                            submitBTN.disabled = false;
                        }
                    } else {
                        this.msg = null;
                        submitBTN.disabled = false;

                        var data = {
                            accountkey: this.accountkey,
                            active: true,
                            name: {
                                firstname: this.firstname,
                                middlename: this.middlename,
                                lastname: this.lastname,
                                suffix: this.suffix ? this.suffix : ''
                            },
                            email: this.email,
                            cellphone: this.cellphone,
                            position: this.position,
                            access: {
                                accountlist: this.accountlist,
                                announcement: this.announcement,
                                applications: this.applications,
                                briefcase: this.briefcase,
                                dashboard: this.dashboard,
                                groups: this.group
                            },
                            type: this.selectedType,
                            group: this.selectedGroup,
                            type_group: this.selectedType + '_' + this.selectedGroup,
                            reports: {
                                salesChart: this.sales,
                                staffChart: this.staff,
                                salesAgentChart: this.salesAgent,
                                salesAgentReport: {
                                    agentsChart: this.agents,
                                    agentstypeChart: this.agentstype,
                                    agentsgroupChart: this.agentsgroup
                                }
                            }
                        };
                        this._finish(data);
                    }
                } else {
                    this.msg = null;
                    submitBTN.disabled = false;
                }
            },

            _finish(data) {
                var newPostKey = firebase.database().ref().child('accountlist').push().key;
                var updates = {};
                if (data.reports.salesAgentChart === true) {
                    var agentData = {
                        firstname: data.name.firstname,
                        middlename: data.name.middlename,
                        lastname: data.name.lastname,
                        suffix: data.name.suffix,
                        cellphone: data.cellphone,
                        email: data.email,
                        type: data.type,
                        group: data.group
                    }
                    updates['/accountlist/' + newPostKey] = data;
                    updates['/agents/' + data.accountkey] = agentData;
                } else {
                    updates['/accountlist/' + newPostKey] = data;
                }
                firebase.database().ref().update(updates);
                this.$.successDialog.open();
            },

            _successDone() {
                this.accountkey = this.guid();
                this.firstname = null;
                this.middlename = null;
                this.lastname = null;
                this.suffix = null;
                this.email = null;
                this.cellphone = null;

                this.dashboard = false;
                this.applications = false;
                this.accountlist = false;
                this.briefcase = false;
                this.announcement = false;
                this.group = false;
            },

            _print() {
                var content = Polymer.dom(this.root).querySelector("#printMe").innerHTML;
                var mywindow = window.open('', 'Print', 'height=600,width=800');
                mywindow.document.write(content);
                mywindow.print();
            },

            _showAgentReports() {
                var salesAgents = Polymer.dom(this.root).querySelector("#salesAgent");
                if (salesAgents.checked == true) {
                    this.hideAgentReports = false;
                } else {
                    this.hideAgentReports = true;
                    this.type = '';
                    this.group = '';
                    this.designation = '';
                }
            },
        })
    </script>
</dom-module>