<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-item/paper-item-body.html">
<link rel="import" href="../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../bower_components/neon-animation/web-animations.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="my-icons.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="short-unique-id.html">

<dom-module id="my-accountlist-edit">
    <template>
        <style include="shared-styles">
            :host {
                display: block;
            }

            app-header {
                color: rgb(255, 255, 255);
                background-color: #388E3C;
            }

            app-header paper-icon-button {
                --paper-icon-button-ink-color: #000000;
            }

            app-drawer-layout:not([narrow]) [drawer-toggle] {
                display: none;
            }

            app-drawer {
                --app-drawer-content-container: {
                    background-color: #F4F5F6;
                }
            }

            paper-icon-button.menu {
                margin-right: 16px;
            }

            paper-item {
                height: 64px;
            }

            .mnu {
                padding: 16px;
            }

            paper-fab {
                background: #1976d2;
            }

            .labelitem {
                padding: 0px;
                margin: 0;
            }

            @media (min-width: 800px) {
                .footer {
                    position: absolute;
                    bottom: 16px;
                    width: 100%;
                }
                .paper-fab-0 {
                    position: absolute;
                    left: 48px;
                    bottom: 48px;
                }
                .paper-fab-1 {
                    position: absolute;
                    right: 48px;
                    bottom: 48px;
                }
            }

            @media (max-width: 800px) {
                .paper-fab-0 {
                    position: absolute;
                    left: 16px;
                    bottom: 48px;
                }
                .paper-fab-1 {
                    position: absolute;
                    right: 16px;
                    bottom: 48px;
                }
                .docu {
                    margin-left: 16px;
                    margin-right: 16px;
                }
            }

            paper-button.indigo {
                background: white;
                height: 32px;
                font-size: 12px;
                font-weight: 400;
                background: green;
                color: white;
                width: 80px;
            }

            paper-button.cancel {
                background: white;
                height: 32px;
                font-size: 12px;
                font-weight: 400;
                width: 80px;
            }

            paper-button.green {
                background-color: var(--paper-green-500);
                color: white;
            }

            paper-checkbox {
                font-size: 14px;
                margin-right: 5px;
            }

            .addrole {
                border: 1px dotted black;
                padding: 16px
            }
        </style>
        <!-- <firebase-document id="transactionFire" path="/accountlist/{{transactionKey}}" data="{{transactionData}}" disabled="true"></firebase-document> -->
        <firebase-document id="query" path="/accountlist/{{transactionKey}}" data="{{editData}}"></firebase-document>
        <app-drawer-layout fullbleed narrow="{{narrow}}" id="drawerLayout">
            <app-header-layout id="appheader" has-scrolling-region>
                <app-header fixed slot="header">
                    <app-toolbar>
                        <a href="/accountlist">
                            <paper-icon-button noink class="menu" style="color: white;" icon="my-icons:arrow-back"></paper-icon-button>
                        </a>
                        <div main-title>Edit Account</div>
                        <paper-icon-button drawer-toggle icon="my-icons:menu"></paper-icon-button>
                        <!-- <paper-icon-button icon="my-icons:more-vert" on-tap="toggleDrawer"></paper-icon-button> -->
                    </app-toolbar>

                    <!-- <paper-dialog id="modal">
                        <h3>Successfully Updated.</h3>
                        <div class="buttons">
                            <a href="/accountlist" style="text-decoration:none">
                                <paper-button dialog-confirm>Ok</paper-button>
                            </a>
                        </div>
                    </paper-dialog> -->
                </app-header>
                <div class="docu">
                    <div class="docu-header">Edit Account</div>
                    <div class="details">
                        <paper-input readonly="true" value="{{accountkey}}" always-float-label label="Account no"></paper-input>
                        <paper-input value="{{firstname}}" always-float-label label="First Name"></paper-input>
                        <paper-input value="{{middlename}}" always-float-label label="Middle Name"></paper-input>
                        <paper-input value="{{lastname}}" always-float-label label="Last Name"></paper-input>
                        <paper-input value="{{suffix}}" always-float-label label="Suffix"></paper-input>
                        <paper-input required allowed-pattern="[\d]" prevent-invalid-input char-counter maxlength="10" value="{{cellphone}}" always-float-label
                            label="Cellphone">
                            <div slot="prefix">+63</div>
                        </paper-input>
                        <paper-dropdown-menu style="cursor:pointer" label="Role">
                            <paper-listbox slot="dropdown-content" class="dropdown-content" selected="{{roleAdd}}">
                                <paper-item>Owner</paper-item>
                                <paper-item>Manager</paper-item>
                                <paper-item>Sales Agent</paper-item>
                                <paper-item>Staff</paper-item>
                            </paper-listbox>
                        </paper-dropdown-menu>
                        <div hidden$="{{managerArea}}" class="addrole">
                            <paper-dropdown-menu label="Type" vertical-offset="60" style="width:150px">
                                <paper-listbox slot="dropdown-content" class="dropdown-content" attr-for-selected="value" selected="{{typefilter}}">
                                    <paper-item value="inhouse">Inhouse</paper-item>
                                    <paper-item value="broker">Broker</paper-item>
                                </paper-listbox>
                            </paper-dropdown-menu>
                        </div>
                        <div hidden$="{{agentArea}}" class="addrole">
                            <paper-dropdown-menu label="Type" vertical-offset="60" style="width:150px">
                                <paper-listbox slot="dropdown-content" class="dropdown-content" attr-for-selected="value" selected="{{typefilter}}">
                                    <paper-item value="inhouse">Inhouse</paper-item>
                                    <paper-item value="broker">Broker</paper-item>
                                </paper-listbox>
                            </paper-dropdown-menu>

                            <firebase-query path="/accountlist" order-by-child="type" equal-to="{{typefilter}}" data="{{accountlistData}}"></firebase-query>
                            <paper-dropdown-menu label="Manager" vertical-offset="60">
                                <paper-listbox slot="dropdown-content" class="dropdown-content" attr-for-selected="value" selected="{{managerfilter}}">
                                    <template is="dom-repeat" items="[[accountlistData]]">
                                        <paper-item id="managerfilteritem" value="[[item.accountkey]]">[[_name(item.name.firstname, item.name.middlename, item.name.lastname)]]</paper-item>
                                    </template>
                                </paper-listbox>
                            </paper-dropdown-menu>

                            <firebase-query path="/user_group/{{managerfilter}}" data="{{groupData}}"></firebase-query>
                            <paper-dropdown-menu label="Group" vertical-offset="60">
                                <paper-listbox slot="dropdown-content" class="dropdown-content" attr-for-selected="value" selected="{{groupfilter}}">
                                    <template is="dom-repeat" items="[[groupData]]">
                                        <paper-item value="[[item.name]]">[[item.name]]</paper-item>
                                    </template>
                                </paper-listbox>
                            </paper-dropdown-menu>

                            <paper-dropdown-menu label="Rank" vertical-offset="60" style="width:150px">
                                <paper-listbox slot="dropdown-content" class="dropdown-content" attr-for-selected="value" selected="{{rankfilter}}">
                                    <paper-item value="teamlead">Team leader</paper-item>
                                    <paper-item value="member">Member</paper-item>
                                </paper-listbox>
                            </paper-dropdown-menu>
                        </div>
                        <div style="font-size:12px; margin-top:1em;">Access</div>
                        <paper-checkbox id="dash">Dashboard</paper-checkbox>
                        <paper-checkbox id="app">Applications</paper-checkbox>
                        <paper-checkbox id="acc">Accounts</paper-checkbox>
                        <paper-checkbox id="case">Briefcase</paper-checkbox>
                        <paper-checkbox id="ann">Announcement</paper-checkbox>
                        <paper-checkbox id="group">Group</paper-checkbox>
                    </div>
                    <br>
                    <br>
                    <paper-button class="indigo" on-click="_done" raised>Update</paper-button>
                    <a href="/accountlist" style="text-decoration:none">
                        <paper-button class="cancel" on-tap="_cancel">Cancel</paper-button>
                    </a>
                    <span style="color:red; font-size:13px; float:right">{{msg}}</span>
                </div>
            </app-header-layout>
        </app-drawer-layout>
    </template>

    <script>
        Polymer({
            is: 'my-accountlist-edit',
            properties: {
                editData: {
                    type: Object,
                    observer: '_editDataChanged'
                },
                equal: {
                    type: String,
                    value: ''
                },
                accountkey: {
                    type: String,
                    value: ''
                },
                transactionKey: {
                    type: String,
                    value: '',
                    observer: 'transactionKeyChanged'
                },
                selectedItem: {
                    observer: '_selectedItemChanged'
                },
                selectedItems: {
                    type: Object,
                },
                keyS: {
                    type: String,
                    value: ''
                },
                roleAdd: {
                    type: Number,
                    value: 1,
                    observer: 'roleAddChanged'
                },
                role: {
                    type: String,
                    value: ''
                },
                access: {
                    type: Boolean,
                    value: ''
                },

                managerArea: {
                    type: Boolean,
                    value: true
                },
                agentArea: {
                    type: Boolean,
                    value: true
                },
                typefilter: {
                    type: String,
                    value: 'none'
                },
                managerfilter: {
                    type: String,
                    value: 'none'
                },
                groupfilter: {
                    type: String,
                    value: 'none'
                },
                rankfilter: {
                    type: String,
                    value: 'none'
                }
            },

            observers: [
                'typefilterChanged(typefilter)',
                'managerfilterChanged(managerfilter)',
                'groupfilterChanged(groupfilter)'
            ],

            typefilterChanged() {
                this.managerfilter = 'none';
            },

            managerfilterChanged(e) {
                this.groupfilter = 'none';
            },

            groupfilterChanged(e) {
                this.rankfilter = 'none';
            },

            roleAddChanged() {
                if (this.roleAdd == 0) {
                    this.role = 'Owner';
                    this.managerArea = true;
                    this.agentArea = true;
                }
                else if (this.roleAdd == 1) {
                    this.role = 'Manager';
                    this.managerArea = false;
                    this.agentArea = true;
                }
                else if (this.roleAdd == 2) {
                    this.role = 'Sales Agent';
                    this.managerArea = true;
                    this.agentArea = false;
                }
                else {
                    this.role = 'Staff';
                    this.managerArea = true;
                    this.agentArea = true;
                }
            },
            _editDataChanged() {
                if (Object.keys(this.editData).length > 0) {
                    this.accountkey = this.editData.accountkey;
                    this.firstname = this.editData.name.firstname;
                    this.middlename = this.editData.name.middlename;
                    this.lastname = this.editData.name.lastname;
                    this.suffix = this.editData.name.suffix;
                    this.cellphone = this.editData.cellphone;

                    if (this.editData.role == "Owner") {
                        this.roleAdd = 0;
                    }
                    if (this.editData.role == "Manager") {
                        this.roleAdd = 1;
                    }
                    if (this.editData.role == "Sales Agent") {
                        this.roleAdd = 2;
                    }
                    if (this.editData.role == "Staff") {
                        this.roleAdd = 3;
                    }

                    if (this.editData.access.accountlist == true) {
                        Polymer.dom(this.root).querySelector("#acc").checked = true;
                    }

                    if (this.editData.access.applications == true) {
                        Polymer.dom(this.root).querySelector("#app").checked = true;
                    }

                    if (this.editData.access.dashboard == true) {
                        Polymer.dom(this.root).querySelector("#dash").checked = true;
                    }
                    if (this.editData.access.briefcase == true) {
                        Polymer.dom(this.root).querySelector("#case").checked = true;
                    }
                    if (this.editData.access.announcement == true) {
                        Polymer.dom(this.root).querySelector("#ann").checked = true;
                    }
                    if (this.editData.access.group == true) {
                        Polymer.dom(this.root).querySelector("#group").checked = true;
                    }

                    this.role = this.role;

                    this.typefilter = this.editData.type;
                    this.managerfilter = this.editData.manager;
                    this.groupfilter = this.editData.team;
                    this.rankfilter = this.editData.rank;
                }
            },
            transactionKeyChanged() {
                this.$.appheader.resetLayout();
            },
            getpath() {
                this.accountkey = this.guid();
            },
            guid: function () {
                var uid = new ShortUniqueId();
                return uid.randomUUID(7);
            },
            _done() {
                var box1 = Polymer.dom(this.root).querySelector("#dash");
                var box2 = Polymer.dom(this.root).querySelector("#app");
                var box3 = Polymer.dom(this.root).querySelector("#acc");
                var box4 = Polymer.dom(this.root).querySelector("#case");
                var box5 = Polymer.dom(this.root).querySelector("#ann");
                var box6 = Polymer.dom(this.root).querySelector("#group");

                var dashboard = false;
                var applications = false;
                var accounts = false;
                var briefcase = false;
                var announcement = false;
                var group = false;

                if (!this.firstname || !this.middlename || !this.lastname) {
                    this.msg = 'Please fill-up the required field.';
                }
                else {
                    if (box1.checked == true) {
                        dashboard = true;
                    }
                    if (box2.checked == true) {
                        applications = true;
                    }
                    if (box3.checked == true) {
                        accounts = true;
                    }
                    if (box4.checked == true) {
                        briefcase = true;
                    }
                    if (box5.checked == true) {
                        announcement = true;
                    }
                    if (box6.checked == true) {
                        group = true;
                    }
                    if (this.cellphone.length != 10) {
                        this.msg = 'Error! Invalid cellphone number.';
                    }
                    else {
                        this.msg = '';
                        if (!this.suffix) {
                            this.suffix = '';
                        }

                        if (this.role == 'Sales Agent') {
                            if (this.typefilter == 'none' || this.managerfilter == 'none' || this.groupfilter == 'none' || this.rankfilter == 'none') {
                                this.msg = 'Error! Please fill up the required field.';
                            } else {
                                this._success(dashboard, applications, accounts, briefcase, announcement, group);
                            }
                        } else if (this.role == 'Manager') {
                            this.managerfilter = 'none';
                            this.groupfilter = 'none';
                            this.rankfilter == 'none';
                            if (this.typefilter == 'none') {
                                this.msg = 'Error! Please fill up the required field.';
                            } else {
                                this._success(dashboard, applications, accounts, briefcase, announcement, group);
                            }
                        }
                        else {
                            this._success(dashboard, applications, accounts, briefcase, announcement, group);
                        }


                    }
                }

            },

            _name(e, f, g) {
                return e + " " + f + " " + " " + g;
            },

            _success(dashboard, applications, accounts, briefcase, announcement, group) {
                var ref = firebase.database().ref('/accountlist');
                ref.child(this.transactionKey).update({
                    accountkey: this.accountkey,
                    access: {
                        accountlist: accounts,
                        applications: applications,
                        dashboard: dashboard,
                        briefcase: briefcase,
                        announcement: announcement,
                        group: group
                    },
                    active: true,
                    name: {
                        firstname: this.firstname,
                        middlename: this.middlename,
                        lastname: this.lastname,
                        suffix: this.suffix
                    },
                    cellphone: this.cellphone,
                    role: this.role,
                    uid: '',
                    type: this.typefilter,
                    manager: this.managerfilter,
                    team: this.groupfilter,
                    rank: this.rankfilter,
                    role_type: this.role + "_" + this.typefilter,
                    manager_team: this.managerfilter + "_" + this.groupfilter,
                });
                window.location = "/accountlist"
            }
        })
    </script>
</dom-module>