<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-item/paper-item-body.html">
<link rel="import" href="../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../bower_components/neon-animation/web-animations.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="my-icons.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="short-unique-id.html">

<dom-module id="my-accountlist-edit">
    <template>
        <style include="shared-styles">
            :host {
                display: block;

                padding: 10px;
            }

            app-header {
                color: rgb(255, 255, 255);
                background-color: #388E3C;
            }

            @media screen and (max-width: 800px) {
                .nameInput {
                    width: 100%;
                }
            }

            @media screen and (min-width: 800px) {
                .nameInput {
                    width: 24%;
                    display: inline-block;
                }
            }

            .container {
                background-color: white;
                padding: 16px;
                box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
            }

            paper-button {
                height: 32px;
                font-size: 12px;
                font-weight: 400;
                width: 80px;
            }

            paper-button.submit {
                background-color: var(--paper-indigo-500);
                color: white;
            }
        </style>

        <firebase-document id="query" path="/accountlist/{{transactionKey}}" data="{{editData}}"></firebase-document>

        <app-drawer-layout fullbleed narrow="{{narrow}}" id="drawerLayout">
            <app-header-layout id="appheader" has-scrolling-region>
                <app-header fixed slot="header">
                    <app-toolbar>
                        <a href="/accountlist">
                            <paper-icon-button noink class="menu" style="color: white;" icon="my-icons:arrow-back" on-tap="cancelPrintPreview"></paper-icon-button>
                        </a>
                        <div main-title >Edit Account</div>
                        <paper-icon-button hidden$="{{acctFirstStep}}" icon="my-icons:print" on-tap="print_preview"></paper-icon-button>
                    </app-toolbar>
                </app-header>

                <div style="padding: 16px;" hidden$="{{acctFirstStep}}">
                    <div class="container">
                        <span style="color:red; font-size:13px; float:right">{{msg}}</span>
                        <paper-input readonly="true" value="{{accountkey}}" always-float-label label="Account No."></paper-input>
                        <paper-input value="{{firstname}}" always-float-label label="First Name" placeholder="Juan" class="nameInput"></paper-input>
                        <paper-input value="{{middlename}}" always-float-label label="Middle Name" placeholder="Dalisay" class="nameInput"></paper-input>
                        <paper-input value="{{lastname}}" always-float-label label="Last Name" placeholder="dela Cruz" class="nameInput"></paper-input>
                        <paper-input value="{{suffix}}" always-float-label label="Suffix" placeholder="Jr" class="nameInput"></paper-input>
                        <paper-input required allowed-pattern="[\d]" prevent-invalid-input char-counter maxlength="10" value="{{cellphone}}" always-float-label
                            label="Cellphone num.">
                            <div slot="prefix">+63</div>
                        </paper-input>
                        <paper-dropdown-menu label="Role" vertical-align="top" horizontal-align="left" vertical-offset="60">
                            <paper-listbox slot="dropdown-content" attr-for-selected="value" selected="{{role}}">
                                <paper-item value="Owner">Owner</paper-item>
                                <paper-item value="Manager">Manager</paper-item>
                                <paper-item value="Sales Agent">Sales Agent</paper-item>
                                <paper-item value="Staff">Staff</paper-item>
                            </paper-listbox>
                        </paper-dropdown-menu>
                        <span hidden$="{{typeHide}}">
                            <paper-dropdown-menu label="Type" vertical-align="top" horizontal-align="left" vertical-offset="60">
                                <paper-listbox slot="dropdown-content" attr-for-selected="value" selected="{{type}}">
                                    <paper-item value="inhouse">In-House</paper-item>
                                    <paper-item value="broker">Broker</paper-item>
                                </paper-listbox>
                            </paper-dropdown-menu>
                        </span>
                        <span hidden$="{{groupHide}}">
                            <paper-dropdown-menu label="Group" vertical-align="top" horizontal-align="left" vertical-offset="60">
                                <paper-listbox slot="dropdown-content" attr-for-selected="value" selected="{{group}}">
                                    <firebase-query path="/group/{{type}}" data="{{groupData}}"></firebase-query>
                                    <template is="dom-repeat" items="[[groupData]]">
                                        <paper-item value="[[item.name]]">[[item.name]]</paper-item>
                                    </template>
                                </paper-listbox>
                            </paper-dropdown-menu>
                        </span>
                        <span hidden$="{{designationHide}}">
                            <paper-dropdown-menu label="Designation" vertical-align="top" horizontal-align="left" vertical-offset="60">
                                <paper-listbox slot="dropdown-content" attr-for-selected="value" selected="{{designation}}">
                                    <paper-item value="Team Leader">Team Leader</paper-item>
                                    <paper-item value="Member">Member</paper-item>
                                </paper-listbox>
                            </paper-dropdown-menu>
                        </span>
                        <div style="font-size:12px; margin-top:10px;">Access</div>
                        <paper-checkbox id="dashboard">Dashboard</paper-checkbox>
                        <paper-checkbox id="applications">Applications</paper-checkbox>
                        <paper-checkbox id="accountlist">Accountlist</paper-checkbox>
                        <paper-checkbox id="briefcase">Briefcase</paper-checkbox>
                        <paper-checkbox id="announcement">Announcement</paper-checkbox>
                        <paper-checkbox id="group">Group</paper-checkbox>
                        <div style="margin-top: 16px">
                            <paper-button class="submit" on-tap="_submit">Update</paper-button>
                        </div>
                    </div>
                </div>

                <div style="border: 5px dotted #bbb;" hidden$="{{acctSecondStep}}">
                    <paper-card style="width: 100%">
                        <div id="printMe" class="card-content">
                            <div>Account No.
                                <span style="font-family: Courier New; font-size: 20px">
                                    <strong>{{accountkey}}</strong>
                                </span>
                            </div>
                            <div>Name: {{firstname}} {{middlename}} {{lastname}} {{suffix}}</div>
                            <div>Contact No. +63{{cellphone}}</div>
                            <div>Role: {{role}}</div>
                            <div>Type: {{type}}</div>
                            <div>Group: {{group}}</div>
                            <div>Designation: {{designation}}</div>
                            <br>
                            <div>
                                <strong>To login to Haven of Peace, Please follow instructions below.</strong>
                            </div>
                            <div>Step 1. Create an account to Haven of Peace under more options</div>
                            <div>Step 2. Verify Email, click the link that was sent to your email account.</div>
                            <div>Step 3. Enter the account number above to link your Haven of Peace account.</div>
                            <div>Step 4. Enter the account code that was sent to your phone number provided above to complete
                                the login procedure.</div>
                        </div>
                        <div class="card-actions">
                            <paper-button on-tap="_print">
                                <iron-icon icon="my-icons:print"></iron-icon> Print</paper-button>
                        </div>
                    </paper-card>
                </div>

            </app-header-layout>
        </app-drawer-layout>
    </template>

    <script>
        Polymer({
            is: 'my-accountlist-edit',
            properties: {
                editData: {
                    type: Object,
                },
                role: String,
                typeHide: Boolean,
                transactionKey: {
                    type: String,
                    value: '',
                },
                acctFirstStep: Boolean,
                acctSecondStep: Boolean
            },

            observers: [
                'roleChanged(role)',
                'transactionKeyChanged(transactionKey)',
                '_editDataChanged(editData)'
            ],

            ready() {
                this.acctFirstStep = false;
                this.acctSecondStep = true;
            },

            roleChanged(e) {
                if (e == 'Manager') {
                    this.typeHide = false;
                    this.groupHide = false;
                    this.designationHide = true;
                } else if (e == 'Sales Agent') {
                    this.typeHide = false;
                    this.groupHide = false;
                    this.designationHide = false;
                } else {
                    this.typeHide = true;
                    this.groupHide = true;
                    this.designationHide = true;
                }
            },

            _editDataChanged() {
                if (Object.keys(this.editData).length > 0) {
                    this.uid = this.editData.uid;
                    this.accountkey = this.editData.accountkey;
                    this.firstname = this.editData.name.firstname;
                    this.middlename = this.editData.name.middlename;
                    this.lastname = this.editData.name.lastname;
                    this.suffix = this.editData.name.suffix;
                    this.cellphone = this.editData.cellphone;
                    this.role = this.editData.role;

                    if (this.editData.access.accountlist == true) {
                        Polymer.dom(this.root).querySelector("#accountlist").checked = true;
                    }

                    if (this.editData.access.applications == true) {
                        Polymer.dom(this.root).querySelector("#applications").checked = true;
                    }

                    if (this.editData.access.dashboard == true) {
                        Polymer.dom(this.root).querySelector("#dashboard").checked = true;
                    }
                    if (this.editData.access.briefcase == true) {
                        Polymer.dom(this.root).querySelector("#briefcase").checked = true;
                    }
                    if (this.editData.access.announcement == true) {
                        Polymer.dom(this.root).querySelector("#announcement").checked = true;
                    }
                    if (this.editData.access.group == true) {
                        Polymer.dom(this.root).querySelector("#group").checked = true;
                    }

                    this.type = this.editData.type;
                    this.group = this.editData.group;
                    this.designation = this.editData.designation;
                }
            },

            transactionKeyChanged() {
                this.$.appheader.resetLayout();
            },

            _submit() {
                if (!this.firstname || !this.middlename || !this.lastname || !this.cellphone || !this.role) {
                    this.msg = 'Please fill-up the required field.';
                } else if (this.cellphone.length != 10) {
                    this.msg = 'Error! Invalid cellphone number...';
                } else {
                    this.msg = '';
                    if (!this.suffix) {
                        this.suffix = '';
                    }
                    var box1 = Polymer.dom(this.root).querySelector("#dashboard");
                    var box2 = Polymer.dom(this.root).querySelector("#applications");
                    var box3 = Polymer.dom(this.root).querySelector("#accountlist");
                    var box4 = Polymer.dom(this.root).querySelector("#briefcase");
                    var box5 = Polymer.dom(this.root).querySelector("#announcement");
                    var box6 = Polymer.dom(this.root).querySelector("#group");

                    var dashboard = false;
                    var applications = false;
                    var accountlist = false;
                    var briefcase = false;
                    var announcement = false;
                    var group = false;

                    if (box1.checked == true) {
                        dashboard = true;
                    }
                    if (box2.checked == true) {
                        applications = true;
                    }
                    if (box3.checked == true) {
                        accountlist = true;
                    }
                    if (box4.checked == true) {
                        briefcase = true;
                    }
                    if (box5.checked == true) {
                        announcement = true;
                    }
                    if (box6.checked == true) {
                        group = true;
                    }

                    if (this.role == 'Manager') {
                        if (!this.type || !this.group) {
                            this.msg = 'Please fill-up the required field.';
                        } else {
                            this.designation = 'none';
                            this._accountSave(dashboard, applications, accountlist, briefcase, announcement, group);
                        }
                    } else if (this.role == 'Owner' || this.role == 'Staff') {
                        this.msg = '';
                        this.type = 'none';
                        this.group = 'none';
                        this.designation = 'none';
                        this._accountSave(dashboard, applications, accountlist, briefcase, announcement, group);
                    } else {
                        if (!this.type || !this.group || !this.designation) {
                            this.msg = 'Please fill-up the required field.';
                        } else {
                            this.msg = '';
                            this._accountSave(dashboard, applications, accountlist, briefcase, announcement, group);
                        }
                    }
                }

            },

            _accountSave(dashboard, applications, accountlist, briefcase, announcement, group) {
                var ref = firebase.database().ref('/accountlist');
                ref.child(this.transactionKey).update({
                    active: true,
                    accountkey: this.accountkey,
                    name: {
                        firstname: this.firstname,
                        middlename: this.middlename,
                        lastname: this.lastname,
                        suffix: this.suffix
                    },
                    cellphone: this.cellphone,
                    role: this.role,
                    type: this.type,
                    group: this.group,
                    type_group: this.type + "_" + this.group,
                    designation: this.designation,
                    access: {
                        dashboard: dashboard,
                        applications: applications,
                        accountlist: accountlist,
                        briefcase: briefcase,
                        announcement: announcement,
                        group: group
                    },
                })
                window.location = '/accountlist';
            },

            cancelPrintPreview() {
                this.acctFirstStep = false;
                this.acctSecondStep = true;
            },

            print_preview() {
                this.acctFirstStep = true;
                this.acctSecondStep = false;
            },

            _print() {
                var content = Polymer.dom(this.root).querySelector("#printMe").innerHTML;
                var mywindow = window.open('', 'Print', 'height=600,width=800');
                mywindow.document.write(content);
                mywindow.print();
            },
        })
    </script>
</dom-module>