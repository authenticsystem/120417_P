<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/neon-animation/web-animations.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/polymerfire/firebase-document.html">

<link rel="import" href="shared-styles.html">

<dom-module id="my-accountlist-edit">
    <template>
        <style include="shared-styles">
            :host {
                display: block;

                padding: 10px;
            }

            app-header {
                color: rgb(255, 255, 255);
                background-color: #388E3C;
            }

            @media screen and (max-width: 800px) {
                .nameInput {
                    width: 100%;
                }
            }

            @media screen and (min-width: 800px) {
                .nameInput {
                    width: 24%;
                    display: inline-block;
                }
            }

            .container {
                background-color: white;
                padding: 16px;
                box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
            }

            paper-button {
                height: 32px;
                font-size: 12px;
                font-weight: 400;
                /* width: 80px; */
            }

            paper-button.submit {
                background-color: var(--paper-indigo-500);
                color: white;
            }

            paper-checkbox {
                margin-right: 5px;
            }
        </style>

        <firebase-document id="query" path="/accountlist/{{transactionKey}}" data="{{editData}}"></firebase-document>

        <app-drawer-layout fullbleed narrow="{{narrow}}" id="drawerLayout">
            <app-header-layout id="appheader" has-scrolling-region>
                <app-header fixed slot="header">
                    <app-toolbar>
                        <a id="href" href="/accountlist">
                            <paper-icon-button noink class="menu" style="color: white;" icon="my-icons:arrow-back"></paper-icon-button>
                        </a>
                        <div main-title>Edit Account</div>
                        <paper-icon-button hidden$="{{printPreview}}" icon="my-icons:print" on-tap="print_preview"></paper-icon-button>
                    </app-toolbar>
                </app-header>

                <template is="dom-if" if="{{!printPreview}}">
                    <div class="container" style="margin: 16px;">
                        <iron-form id="accountlistForm">
                            <form>
                                <span style="color:red; font-size:13px; float:right">{{msg}}</span>

                                <paper-input readonly value="{{accountkey}}" always-float-label label="Account Key"
                                    required></paper-input>
                                <paper-input value="{{firstname}}" always-float-label label="First Name" class="nameInput"
                                    required></paper-input>
                                <paper-input value="{{middlename}}" always-float-label label="Middle Name" class="nameInput"
                                    required></paper-input>
                                <paper-input value="{{lastname}}" always-float-label label="Last Name" class="nameInput"
                                    required></paper-input>
                                <paper-input value="{{suffix}}" always-float-label label="Suffix" class="nameInput"></paper-input>
                                <paper-input value="{{email}}" always-float-label label="Email" required></paper-input>
                                <paper-input required allowed-pattern="[\d]" prevent-invalid-input char-counter
                                    maxlength="10" value="{{cellphone}}" always-float-label label="Cellphone num.">
                                    <div slot="prefix">+63</div>
                                </paper-input>
                                <paper-input label="Position" value="{{position}}" required></paper-input>

                                <div style="font-size:12px; margin-top:10px;">Access</div>
                                <paper-checkbox checked="{{dashboard}}">Dashboard</paper-checkbox>
                                <paper-checkbox checked="{{applications}}">Applications</paper-checkbox>
                                <paper-checkbox checked="{{accountlist}}">Accountlist</paper-checkbox>
                                <paper-checkbox checked="{{briefcase}}">Briefcase</paper-checkbox>
                                <paper-checkbox checked="{{announcement}}">Announcement</paper-checkbox>
                                <paper-checkbox checked="{{group}}">Group</paper-checkbox>

                                <template is="dom-if" if="{{dashboard}}">
                                    <div>
                                        <div style="font-size:12px; margin-top:10px;">Reports</div>
                                        <paper-checkbox checked="{{sales}}">Owner</paper-checkbox>
                                        <paper-checkbox checked="{{staff}}">Staff</paper-checkbox>
                                        <paper-checkbox checked="{{salesAgent}}">Agent</paper-checkbox>
                                    </div>
                                </template>

                                <template is="dom-if" if="{{salesAgent}}">
                                    <div>
                                        <div style="font-size:12px; margin-top:10px;">Agent Reports</div>
                                        <paper-checkbox checked="{{agentstype}}">Agents Type</paper-checkbox>
                                        <paper-checkbox checked="{{agentsgroup}}">Agents Group</paper-checkbox>
                                        <paper-checkbox checked="{{agents}}">All Agents</paper-checkbox>
                                    </div>
                                    <div>
                                        <paper-dropdown-menu label="Type" vertical-align="top" horizontal-align="left"
                                            vertical-offset="60" required>
                                            <paper-listbox slot="dropdown-content" attr-for-selected="value" selected="{{selectedType}}">
                                                <paper-item value="inhouse">In-House</paper-item>
                                                <paper-item value="broker">Broker</paper-item>
                                            </paper-listbox>
                                        </paper-dropdown-menu>
                                        <paper-dropdown-menu label="Group" vertical-align="top" horizontal-align="left"
                                            vertical-offset="60" required>
                                            <paper-listbox slot="dropdown-content" attr-for-selected="value" selected="{{selectedGroup}}">
                                                <firebase-query path="/group/{{selectedType}}" data="{{groupData}}"></firebase-query>
                                                <template is="dom-repeat" items="[[groupData]]">
                                                    <paper-item value="[[item.groupID]]">[[item.name]]</paper-item>
                                                </template>
                                            </paper-listbox>
                                        </paper-dropdown-menu>
                                        <!-- <paper-dropdown-menu label="Designation" vertical-align="top" horizontal-align="left" vertical-offset="60">
                                        <paper-listbox slot="dropdown-content" attr-for-selected="value" selected="{{designation}}">
                                            <paper-item value="Team Leader">Team Leader</paper-item>
                                            <paper-item value="Member">Member</paper-item>
                                        </paper-listbox>
                                    </paper-dropdown-menu> -->
                                    </div>
                                </template>

                            </form>
                        </iron-form>

                        <div style="margin-top: 16px">
                            <paper-button id="submitBTN" class="submit" on-tap="_submit">Update</paper-button>
                        </div>
                    </div>
                </template>

                <!-- <paper-dialog id="submitDialog">
                    <p>
                        <h2>Update account?</h2>
                    </p>
                    <div class="buttons">
                        <paper-button dialog-dismiss>Cancel</paper-button>
                        <paper-button dialog-confirm autofocus on-tap="_submit">Update</paper-button>
                    </div>
                </paper-dialog> -->

                <paper-dialog id="successDialog" no-cancel-on-outside-click>
                    <div style="text-align: center;">
                        <h3>Account updated successfully!</h3>
                    </div>
                    <div class="buttons">
                        <paper-button dialog-dismiss on-tap="_successDone">OK</paper-button>
                    </div>
                </paper-dialog>

                <template is="dom-if" if="{{printPreview}}">
                    <div style="padding: 16px;">
                        <paper-card style="width: 100%">
                            <div id="printMe" class="card-content">
                                <div>Account No.
                                    <span style="font-family: Courier New; font-size: 20px">
                                        <strong>{{accountkey}}</strong>
                                    </span>
                                </div>
                                <div>Name: {{firstname}} {{middlename}} {{lastname}} {{suffix}}</div>
                                <div>Contact No. +63{{cellphone}}</div>
                                <div>Position: {{position}}</div>
                                <div>Type: {{type}}</div>
                                <div>Group: {{group}}</div>
                                <br>
                                <div>
                                    <strong>To login to Haven of Peace, Please follow instructions below.</strong>
                                </div>
                                <div>Step 1. Create an account to Haven of Peace under more options</div>
                                <div>Step 2. Verify Email, click the link that was sent to your email account.</div>
                                <div>Step 3. Enter the account number above to link your Haven of Peace account.</div>
                                <div>Step 4. Enter the account code that was sent to your phone number provided above
                                    to
                                    complete the login procedure.</div>
                            </div>
                            <div class="card-actions">
                                <span style="float: right; margin-bottom: 8px;">
                                    <paper-button on-tap="_closePrintPreview">Cancel</paper-button>
                                    <paper-button on-tap="_print">
                                        <!-- <iron-icon icon="my-icons:print"></iron-icon> Print --> Print
                                    </paper-button>
                                </span>
                            </div>
                        </paper-card>
                    </div>
                </template>

            </app-header-layout>
        </app-drawer-layout>
    </template>

    <script>
        Polymer({
            is: 'my-accountlist-edit',
            properties: {
                editData: {
                    type: Object,
                },
                transactionKey: {
                    type: String,
                    value: '',
                },
                printPreview: {
                    type: Boolean,
                    value: false
                }
            },

            observers: [
                'transactionKeyChanged(transactionKey)',
                '_editDataChanged(editData)',
                '_salesAgentChanged(salesAgent)',
                '_dashboardChanged(dashboard)'
            ],

            _salesAgentChanged(e) {
                if (e === false) {
                    this.agentstype = false;
                    this.agentsgroup = false;
                    this.agents = false;

                    this.selectedType = '';
                    this.selectedGroup = '';
                }
            },

            _dashboardChanged(e) {
                if (e === false) {
                    this.sales = false;
                    this.staff = false;
                    this.salesAgent = false;
                }
            },

            _editDataChanged() {
                if (Object.keys(this.editData).length > 0) {
                    this.uid = this.editData.uid;
                    this.accountkey = this.editData.accountkey;
                    this.firstname = this.editData.name.firstname;
                    this.middlename = this.editData.name.middlename;
                    this.lastname = this.editData.name.lastname;
                    this.suffix = this.editData.name.suffix;
                    this.cellphone = this.editData.cellphone;
                    this.email = this.editData.email;
                    this.position = this.editData.position;
                    this.selectedType = this.editData.type;
                    this.selectedGroup = this.editData.group;

                    this.accountlist = this.editData.access.accountlist;
                    this.applications = this.editData.access.applications;
                    this.dashboard = this.editData.access.dashboard;
                    this.briefcase = this.editData.access.briefcase;
                    this.announcement = this.editData.access.announcement;
                    this.group = this.editData.access.groups;

                    this.staff = this.editData.reports.staffChart;
                    this.salesAgent = this.editData.reports.salesAgentChart;
                    this.sales = this.editData.reports.salesChart;

                    this.agentstype = this.editData.reports.salesAgentReport.agentstypeChart;
                    this.agentsgroup = this.editData.reports.salesAgentReport.agentsgroupChart;
                    this.agents = this.editData.reports.salesAgentReport.agentsChart;
                }
            },

            transactionKeyChanged() {
                Polymer.dom(this.root).querySelector("#appheader").resetLayout();
            },

            _submit() {
                var submitBTN = Polymer.dom(this.root).querySelector('#submitBTN');
                var accountlistForm = Polymer.dom(this.root).querySelector('#accountlistForm');

                accountlistForm.submit();
                submitBTN.disabled = true;

                if (this.firstname && this.middlename && this.lastname && this.email && this.cellphone && this.position) {
                    if (this.cellphone.length != 10) {
                        this.msg = 'Error! Invalid cellphone number...';
                        submitBTN.disabled = false;
                    } else if (this.salesAgent === true) {
                        if (this.selectedType && this.selectedGroup) {
                            this.msg = null;
                            submitBTN.disabled = false;

                            var data = {
                                uid: this.uid ? this.uid : '',
                                accountkey: this.accountkey,
                                active: true,
                                name: {
                                    firstname: this.firstname,
                                    middlename: this.middlename,
                                    lastname: this.lastname,
                                    suffix: this.suffix ? this.suffix : ''
                                },
                                email: this.email,
                                cellphone: this.cellphone,
                                position: this.position,
                                access: {
                                    accountlist: this.accountlist,
                                    announcement: this.announcement,
                                    applications: this.applications,
                                    briefcase: this.briefcase,
                                    dashboard: this.dashboard,
                                    groups: this.group
                                },
                                type: this.selectedType,
                                group: this.selectedGroup,
                                type_group: this.selectedType + '_' + this.selectedGroup,
                                reports: {
                                    salesChart: this.sales,
                                    staffChart: this.staff,
                                    salesAgentChart: this.salesAgent,
                                    salesAgentReport: {
                                        agentsChart: this.agents,
                                        agentstypeChart: this.agentstype,
                                        agentsgroupChart: this.agentsgroup
                                    }
                                }
                            };
                            this._finish(data);
                        } else {
                            this.msg = null;
                            submitBTN.disabled = false;
                        }
                    } else {
                        this.msg = null;
                        submitBTN.disabled = false;

                        var data = {
                            uid: this.uid ? this.uid : '',
                            accountkey: this.accountkey,
                            active: true,
                            name: {
                                firstname: this.firstname,
                                middlename: this.middlename,
                                lastname: this.lastname,
                                suffix: this.suffix ? this.suffix : ''
                            },
                            email: this.email,
                            cellphone: this.cellphone,
                            position: this.position,
                            access: {
                                accountlist: this.accountlist,
                                announcement: this.announcement,
                                applications: this.applications,
                                briefcase: this.briefcase,
                                dashboard: this.dashboard,
                                groups: this.group
                            },
                            type: this.selectedType,
                            group: this.selectedGroup,
                            type_group: this.selectedType + '_' + this.selectedGroup,
                            reports: {
                                salesChart: this.sales,
                                staffChart: this.staff,
                                salesAgentChart: this.salesAgent,
                                salesAgentReport: {
                                    agentsChart: this.agents,
                                    agentstypeChart: this.agentstype,
                                    agentsgroupChart: this.agentsgroup
                                }
                            }
                        };
                        this._finish(data);
                    }
                } else {
                    this.msg = null;
                    submitBTN.disabled = false;
                }
            },

            _finish(data) {
                // var newPostKey = firebase.database().ref().child('accountlist').push().key;
                var newPostKey = this.transactionKey;
                var updates = {};
                if (data.reports.salesAgentChart === true) {
                    var agentData = {
                        firstname: data.name.firstname,
                        middlename: data.name.middlename,
                        lastname: data.name.lastname,
                        suffix: data.name.suffix,
                        cellphone: data.cellphone,
                        email: data.email,
                        type: data.type,
                        group: data.group
                    }
                    updates['/accountlist/' + newPostKey] = data;
                    updates['/agents/' + data.accountkey] = agentData;
                } else {
                    updates['/accountlist/' + newPostKey] = data;
                }
                firebase.database().ref().update(updates);
                Polymer.dom(this.root).querySelector("#successDialog").open();
            },

            _successDone(){
                window.location = '/accountlist';
            },

            print_preview() {
                this.printPreview = true
            },

            _closePrintPreview() {
                this.printPreview = false;
            },

            _print() {
                var content = Polymer.dom(this.root).querySelector("#printMe").innerHTML;
                var mywindow = window.open('', 'Print', 'height=600,width=800');
                mywindow.document.write(content);
                mywindow.print();
            },
        })
    </script>
</dom-module>