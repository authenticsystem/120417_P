<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/polymerfire/firebase-document.html">
<!-- <link rel="import" href="../bower_components/polymerfire/firebase-messaging.html"> -->
<link rel="import" href="../bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/paper-button-group/paper-button-group.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/neon-animation/web-animations.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-menu-button/paper-menu-button.html">

<link rel="import" href="shared-styles.html">
<link rel="import" href="my-icons.html">
<link rel="import" href="../bower_components/polymerfire/firebase-auth.html">

<script src="../bower_components/chart.js/dist/Chart.js"></script>
<script src="../bower_components/chartjs-plugin-datalabels/dist/Chartjs-plugin-datalabels.js"></script>


<dom-module id="my-dashboard">
  <template>
    <style include="shared-styles">
      :host {
        display: block;

        padding: 10px;
      }

      app-header {
        color: rgb(255, 255, 255);
        background-color: #388E3C;
      }

      paper-icon-button.menu {
        margin-right: 16px;
      }

      iron-image {
        margin: 0 auto;
      }

      @media (max-width: 768px) {
        paper-button-group {
          height: 30px;
          width: 300px;
        }
        .card {
          margin-left: 10px;
          margin-right: 10px;
        }
        #flex {
          display: flex;
        }
        #flexMain {
          display: block;
        }
        #date {
          display: none;
        }
        #icons {
          display: block;
        }
        #tabs {
          display: none;
        }
      }



      @media (min-width: 768px) {
        paper-button-group {
          height: 30px;
          width: 300px;
          size: 10px;
        }
        .card {
          margin-left: 10px;
          margin-right: 10px;
        }
        #flexMain {
          display: flex;
        }

        #flex {
          display: flex;
        }
        #date {
          float: left;
          margin-top: 50px;
        }
        #card1 {
          margin-top: 10px;
        }
        #icons {
          display: none;
        }
        #tabs {
          display: block;
        }
      }

      table,
      th,
      td {
        border: 1px solid gray;
        border-collapse: collapse;
      }

      th,
      td {
        padding: 5px;
        text-align: right;
      }

      .smallButton {
        min-width: 3em;
        padding: 0em;
        margin: 0.2em;
        min-height: 2em;
        padding: 5px;
        font-size: 13px;
      }

      paper-button[toggles] {
        transition: background-color 0.3s;
      }

      paper-button[active] {
        color: white;
        background-color: var(--paper-pink-500);
        --paper-button-flat-focus-color: var(--paper-pink-50);
      }

      paper-button[toggles][active] {
        color: white;
        background-color: var(--paper-pink-500);
        --paper-button-flat-focus-color: var(--paper-pink-50);
      }

      paper-button:hover {
        background: #eee;
      }

      paper-button.ripple::shadow paper-ripple {
        color: var(--paper-pink-a200);
      }

      paper-button.ripple paper-ripple {
        color: var(--paper-pink-a200);
      }

      canvas {
        width: 100% !important;
        max-width: 900px;
        height: auto !important;
      }

      @media (max-width: 768px) {
        paper-button-group {
          height: 30px;
          width: 300px;
        }
        .card {
          margin-left: 10px;
          margin-right: 10px;
        }
        #flex {
          display: flex;
        }
        #flexMain {
          display: block;
        }
        #date {
          display: none;
        }
        #icons {
          display: block;
        }
        #tabs {
          display: none;
        }
      }

      @media (min-width: 768px) {
        paper-button-group {
          height: 30px;
          width: 300px;
          size: 10px;
        }
        .card {
          margin-left: 10px;
          margin-right: 10px;
        }
        #flexMain {
          display: flex;
        }

        #flex {
          display: flex;
        }
        #date {
          float: left;
          margin-top: 50px;
        }
        #card1 {
          margin-top: 10px;
        }
        #icons {
          display: none;
        }
        #tabs {
          display: block;
        }
      }

      paper-button.blue {
        --paper-button-checked-color: var(--paper-light-blue-500);
        --paper-button-checked-ink-color: var(--paper-light-blue-500);
        --paper-button-unchecked-color: var(--paper-light-blue-900);
        --paper-button-unchecked-ink-color: var(--paper-light-blue-900);
      }
    </style>

    <firebase-auth id="auth" status-known="{{statusKnown}}" user="{{user}}" on-error="showError"></firebase-auth>
    <firebase-messaging id="messaging" on-message="handleMessage" token="{{token}}"></firebase-messaging>
    <firebase-document path="/users/[[user.uid]]/token" data="[[token]]"></firebase-document>

    <firebase-query path="/reports/lotstatus/Today" limit-to-first=50 data="{{todayLotStatus}}"></firebase-query>

    <firebase-query path="/reports/overAll/{{overAllDate}}/lotType" data="{{overallData}}"></firebase-query>
    <!-- <firebase-query path="/reports/overAll/{{overAllDate}}/overall" data="{{overallTotalData}}"></firebase-query> -->

    <app-header-layout fullbleed has-scrolling-region>
      <app-header fixed slot="header">
        <app-toolbar primary>
          <paper-icon-button class="menu" icon="my-icons:menu" drawer-toggle on-tap="toggleDrawer"></paper-icon-button>
          <div main-title hidden$="{{!access}}">Dashboard</div>
          <div main-title hidden$="{{access}}">Opps!</div>
        </app-toolbar>
        <paper-tabs selected="{{selectedTab}}" scrollable>
          <paper-tab>
            <iron-icon icon="my-icons:announcement" id="icons"></iron-icon>
            <span id="tabs">Announcements</span>
          </paper-tab>
          <paper-tab>
            <iron-icon icon="my-icons:assessment" id="icons"></iron-icon>
            <span id="tabs">Reports</span>
          </paper-tab>
        </paper-tabs>
      </app-header>

      <template is="dom-if" if="{{!access}}">
        <div class="card">
          <h3>Sorry!</h3>
          <div>You're not allowed to access this content.</div>
        </div>
      </template>
      <!-- <div class="bg"> -->
      <template is="dom-if" if="{{access}}">

        <iron-pages selected="{{selectedTab}}">

          <!-- Announcements -->
          <div class="card">
            <h3 style="display: inline-block;">
              Activity Report: Today
              <span style="display: inline-block; font-weight: bold; font-size: 12px; background:#B71C1C; border-radius: 2px; color: white; padding-left: 4px;padding-right: 4px;">
                DRY RUN
              </span>
            </h3>
            <div style="padding-top: 3px; font-size: 14px;">
              <table>
                <tr>
                  <th style="text-align: left;">Type</th>
                  <th style="color: orange;">Hold</th>
                  <th style="color: rgb(145, 145, 0);">Reserved</th>
                  <th style="color: red;">Sold</th>
                </tr>
                <template is="dom-repeat" items="{{todayLotStatus}}">
                  <tr>
                    <td style="text-align: left;">{{_formatType(item.$key)}}</td>
                    <td style="color: black;">{{_formatNumber(item.hold)}}</td>
                    <td style="color: black;">{{_formatNumber(item.reserved)}}</td>
                    <td style="color: black;">{{_formatNumber(item.sold)}}</td>
                  </tr>
                </template>
              </table>
            </div>
          </div>
          <!-- End of Announcements -->

          <!-- Reports -->
          <div>
            <div class="card">
              <firebase-query id="query" path="reports/activity/daily/{{dailyDate}}" data="{{dailyTotal}}"></firebase-query>
              <firebase-query id="query" path="reports/activity/monthly/{{yearDate}}-{{monthDate}}" data="{{monthlyTotal}}"></firebase-query>
              <firebase-query id="query" path="reports/activity/yearly/{{yearlyDate}}" data="{{yearlyTotal}}"></firebase-query>

              <paper-button-group selected="{{selectedReport}}">
                <paper-button class="smallButton">Activity</paper-button>|
                <paper-button class="smallButton">Comparative</paper-button>|
                <paper-button class="smallButton">Over All</paper-button>
              </paper-button-group>
            </div>

            <!--daily Activity Report -->
            <div class="card" hidden$="{{hideActivity}}">

              <div style="float:right;">
                <paper-button-group selected="{{selectedDMY}}">
                  <paper-button class="smallButton">Daily</paper-button>|
                  <paper-button class="smallButton">Monthly</paper-button>|
                  <paper-button class="smallButton">Yearly</paper-button>
                </paper-button-group>
              </div>

              <paper-input prefix="" hidden$="{{hideDailyInputDate}}" id="myDate" label="Date" type="date" value="{{dailyAct}}" style="display:inline-block; margin-top:5px">
                <iron-icon icon="my-icons:event" slot="prefix"></iron-icon>
              </paper-input>

              <span hidden$="{{hideMonthSelection}}">
                <paper-dropdown-menu class="month" label="Month">
                  <paper-listbox slot="dropdown-content" class="month" attr-for-selected="value" selected="{{month}}">
                    <paper-item value="01">January</paper-item>
                    <paper-item value="02">February</paper-item>
                    <paper-item value="03">March</paper-item>
                    <paper-item value="04">April</paper-item>
                    <paper-item value="05">May</paper-item>
                    <paper-item value="06">June</paper-item>
                    <paper-item value="07">July</paper-item>
                    <paper-item value="08">August</paper-item>
                    <paper-item value="09">September</paper-item>
                    <paper-item value="10">October</paper-item>
                    <paper-item value="11">November</paper-item>
                    <paper-item value="12">December</paper-item>
                  </paper-listbox>
                </paper-dropdown-menu>

                <paper-input value={{year}} style="margin-top:-50px; display:inline-block" type="number" label="Year">
                  <!-- <paper-icon-button on-tap="lessYear" icon="my-icons:chevron-left" slot="suffix"></paper-icon-button>
                  <paper-icon-button on-tap="addYear" id="addYear" icon="my-icons:chevron-right" slot="suffix"></paper-icon-button> -->
                </paper-input>
              </span>

              <paper-input hidden$="{{hideYearly}}" value={{yearly}} type="number" style="display:inline-block" label="Year">
                <iron-icon icon="my-icons:event" slot="prefix"></iron-icon>
                <!-- <paper-icon-button on-tap="lessYear" icon="my-icons:chevron-left" slot="suffix"></paper-icon-button>
                <paper-icon-button on-tap="addYearly" id="addYear" icon="my-icons:chevron-right" slot="suffix"></paper-icon-button> -->
              </paper-input>

              <div style="text-align:center; margin-bottom:20px; margin-top:20px">
                <div style="display:inline-block; padding:0; margin-right:5px; color:white; width:20%; border:1px solid red">
                  <div style="background-color:red; font-size:12px">Total Sold</div>
                  <span style="color:red; font-size:20px">{{totalSold}}</span>
                </div>
                <div style="display:inline-block; padding:0; margin-right:5px; color:white; width:20%; border:1px solid orange">
                  <div style="background-color:orange; font-size:12px">Total Reserved</div>
                  <span style="color:orange; font-size:20px">{{totalReserved}}</span>
                </div>
                <div style="display:inline-block; padding:0; color:white; width:20%; border:1px solid rgb(145, 145, 0)">
                  <div style="background-color:rgb(145, 145, 0); font-size:12px">Total Hold</div>
                  <span style="color:rgb(145, 145, 0); font-size:20px">{{totalHold}}</span>
                </div>
              </div>
              <div class="chart-container">
                <canvas id="dailyChart"></canvas>
              </div>

            </div>
            <!--end daily Activity Report -->

            <!-- comparative report -->
            <div id="comparative" class="card" hidden$="{{hideComparative}}">
              <div style="float:right;">
                <div id="flex">
                  <div style="margin-top:30px;position:absolute;top:50px;right:16px;">
                    <paper-button-group id="daily" selected="{{selectedDaily}}">
                      <paper-button style="display:none">Daily</paper-button>
                      <paper-button>Daily</paper-button>
                      <paper-button>Monthly</paper-button>
                      <paper-button>Yearly</paper-button>
                    </paper-button-group>
                  </div>
                </div>
              </div>

              <div id="flexMain" style="margin-top:40px;">
                <paper-dropdown-menu style="cursor:pointer;" id="all" label="Filter">
                  <paper-listbox slot="dropdown-content" selected="{{DailyfilterBy}}">
                    <paper-item style="display:none">All</paper-item>
                    <paper-item>All</paper-item>
                    <paper-item>Bone Chamber</paper-item>
                    <paper-item>Lawn Lot</paper-item>
                    <paper-item>Cinerarium</paper-item>
                    <paper-item>Wall Niche</paper-item>
                  </paper-listbox>
                </paper-dropdown-menu>


                <div id="Daily">
                  <div id="flex">
                    <div id="flex">
                      <iron-icon style="margin-top:30px; margin-right:10px;color:dodgerblue;" icon="my-icons:event" id="date"></iron-icon>
                      <paper-input label="Start Date" type="date" value="{{startDate}}" id="day"></paper-input>
                    </div>
                    <div id="flex">
                      <iron-icon style="margin-top:30px; margin-right:10px;color:dimgray;" icon="my-icons:event" id="date"></iron-icon>
                      <paper-input label="End Date" type="date" value="{{endDate}}" id="day"></paper-input>
                    </div>
                  </div>
                </div>


                <div style="display:none" id="Monthly">
                  <div id="flex">
                    <div id="flex">
                      <iron-icon style="margin-top:30px; margin-right:10px;color:dodgerblue" icon="my-icons:event" id="date"></iron-icon>
                      <paper-dropdown-menu style="cursor:pointer" label="Start Month">
                        <paper-listbox slot="dropdown-content" selected="{{startRange}}">
                          <paper-item>January</paper-item>
                          <paper-item>February</paper-item>
                          <paper-item>March</paper-item>
                          <paper-item>April</paper-item>
                          <paper-item>May</paper-item>
                          <paper-item>June</paper-item>
                          <paper-item>July</paper-item>
                          <paper-item>August</paper-item>
                          <paper-item>September</paper-item>
                          <paper-item>October</paper-item>
                          <paper-item>November</paper-item>
                          <paper-item>December</paper-item>
                        </paper-listbox>
                      </paper-dropdown-menu>
                    </div>
                    <div id="flex">
                      <div id="firstyear">
                        <paper-dropdown-menu style="cursor:pointer" label="Start Year">
                          <paper-listbox slot="dropdown-content" selected="{{startMonthYear}}" attr-for-selected="value">
                            <paper-item value="2015">2015</paper-item>
                            <paper-item value="2016">2016</paper-item>
                            <paper-item value="2017">2017</paper-item>
                            <paper-item value="2018">2018</paper-item>
                          </paper-listbox>
                        </paper-dropdown-menu>
                      </div>
                    </div>
                    <div id="flex">
                      <iron-icon style="margin-top:30px; margin-right:20px;color:dimgray;" icon="my-icons:event" id="date"></iron-icon>
                      <paper-dropdown-menu style="cursor:pointer" label="Start Month">
                        <paper-listbox slot="dropdown-content" selected="{{endRange}}">
                          <paper-item>January</paper-item>
                          <paper-item>February</paper-item>
                          <paper-item>March</paper-item>
                          <paper-item>April</paper-item>
                          <paper-item>May</paper-item>
                          <paper-item>June</paper-item>
                          <paper-item>July</paper-item>
                          <paper-item>August</paper-item>
                          <paper-item>September</paper-item>
                          <paper-item>October</paper-item>
                          <paper-item>November</paper-item>
                          <paper-item>December</paper-item>
                        </paper-listbox>
                      </paper-dropdown-menu>
                    </div>
                    <div id="flex">
                      <div id="lastyear">
                        <paper-dropdown-menu style="cursor:pointer" label="End Year">
                          <paper-listbox slot="dropdown-content" selected="{{endMonthYear}}" attr-for-selected="value">
                            <paper-item value="2015">2015</paper-item>
                            <paper-item value="2016">2016</paper-item>
                            <paper-item value="2017">2017</paper-item>
                            <paper-item value="2018">2018</paper-item>
                          </paper-listbox>
                        </paper-dropdown-menu>
                      </div>
                    </div>
                  </div>
                </div>

                <div style="display:none" id="Yearly">
                  <div id="flex">
                    <div id="flex">
                      <iron-icon style="margin-top:30px; margin-right:10px;color:dodgerblue" icon="my-icons:event" id="date"></iron-icon>
                      <paper-dropdown-menu style="cursor:pointer" label="Start Year">
                        <paper-listbox slot="dropdown-content" selected="{{startYear}}">
                          <paper-item>2015</paper-item>
                          <paper-item>2016</paper-item>
                          <paper-item>2017</paper-item>
                          <paper-item>2018</paper-item>
                        </paper-listbox>
                      </paper-dropdown-menu>
                    </div>
                    <div id="flex">
                      <iron-icon style="margin-top:30px; margin-right:20px;color:dimgray;" icon="my-icons:event" id="date"></iron-icon>
                      <paper-dropdown-menu style="cursor:pointer" label="End Year">
                        <paper-listbox slot="dropdown-content" selected="{{endYear}}">
                          <paper-item>2015</paper-item>
                          <paper-item>2016</paper-item>
                          <paper-item>2017</paper-item>
                          <paper-item>2018</paper-item>
                        </paper-listbox>
                      </paper-dropdown-menu>
                    </div>
                  </div>
                </div>

              </div>

              <div class="card" id="card1" style="display:none;margin-top:250px;">
                <canvas id="myChart"></canvas>
              </div>
            </div>
            <!-- end comparative report -->

            <!--OverAll Report -->
            <div class="card" hidden$="{{hideOverAll}}">
              <span style="display:flex;">
                <span class="typeSelection" style="margin-right:8px; width:150px; font-size:15px; margin-top:2px;">
                  <paper-dropdown-menu class="month" label="Lot type">
                    <paper-listbox slot="dropdown-content" class="month" attr-for-selected="value" selected="{{lotType}}">
                      <paper-item value="all" style="font-size:13px">All</paper-item>
                      <paper-item value="lawnlots" style="font-size:13px">lawnlots</paper-item>
                      <paper-item value="bonechamber" style="font-size:13px">bonechamber</paper-item>
                    </paper-listbox>
                  </paper-dropdown-menu>
                </span>

                <span class="date" style="margin-right:15px;">
                  <paper-input value={{overAllDate}} type="date" label="As of" style="width:150px;">
                    <iron-icon icon="my-icons:event" slot="prefix"></iron-icon>
                  </paper-input>
                </span>

                <a hidden$="{{hideSummary}}" on-tap="_showSummary" style="font-size:12px; text-decoration:none; margin-top:25px; cursor:pointer">Summary</a>
                <a hidden$="{{showSummary}}" on-tap="_hideSummary" style="font-size:12px; text-decoration:none; margin-top:25px; cursor:pointer">Graph</a>
              </span>

              <div class="chart-container" hidden$="{{overallchart}}">
                <canvas id="overAllChart"></canvas>
              </div>
              <br>

              <div style="padding-top: 3px; font-size: 14px;" hidden$="{{hideSummaryTable}}">
                <table>
                  <tr>
                    <th style="text-align: left;">Type</th>
                    <th style="color: green;">Available</th>
                    <th style="color: orange;">Hold</th>
                    <th style="color: gray;">Not yet available</th>
                    <th style="color: rgb(145, 145, 0);">Reserved</th>
                    <th style="color: red;">Sold</th>
                    <th>Total</th>
                  </tr>
                  <template is="dom-repeat" items="{{overallData}}">
                    <tr>
                      <td style="text-align: left;">{{_formatType(item.$key)}}</td>
                      <td style="color: black;">{{_formatAllNumber(item.available)}}</td>
                      <td style="color: black;">{{_formatAllNumber(item.hold)}}</td>
                      <td style="color: black;">{{_formatAllNumber(item.notyetavailable)}}</td>
                      <td style="color: black;">{{_formatAllNumber(item.reserved)}}</td>
                      <td style="color: black;">{{_formatAllNumber(item.sold)}}</td>
                      <td style="color: black;font-weight:bold">{{_formatAllTotal(item.available,item.hold,item.notyetavailable,item.reserved,item.sold)}}</td>
                    </tr>
                  </template>
                </table>
              </div>
            </div>
            <!--end OverAll Report -->

          </div>
          <!-- End of Reports -->
        </iron-pages>

      </template>
    </app-header-layout>
  </template>

  <script>
    Polymer({
      is: 'my-dashboard',
      properties: {
        narrow: {
          type: Boolean,
          notify: true
        },
        access: {
          type: Boolean,
          value: false
        },
        token: {
          type: Object,
          observer: 'tokenChanged'
        },
        selectedTab: {
          type: Number,
          value: 0
        },
        selectedReport: {
          type: Number,
        },
        selectedDMY: Number,
        dailyAct: {
          type: String,
        },
        dailyTotal: {
          type: Object,
        },
        monthlyTotal: {
          type: Object
        },
        yearlyTotal: {
          type: Object
        },
        data: String,
        hideDailyInputDate: {
          type: Boolean,
          value: false
        },
        hideMonthSelection: {
          type: Boolean,
          value: true
        },
        hideYearly: {
          type: Boolean,
          value: true
        },
        month: String,
        year: Number,
        yearly: {
          type: Number,
        },
        Chart: Object,
        allChart: Object,
        hideActivity: Boolean,
        hideComparative: Boolean,
        hideOverAll: Boolean,
        overAllDate: Number,
        lotType: String,
        // overallTotalData: {
        //   observer: 'overallTotalDataChanged'
        // },
        hideSummary: {
          type: Boolean,
          value: true,
        },
        showSummary: {
          type: Boolean,
          value: true
        },
        hideSummaryTable: {
          type: Boolean,
          value: true
        },
        overallchart: Boolean,
        selectedDaily: {
          type: Number,
          value: 1
        },
        selectedButtons: {
          type: Number,
          value: 0,
          observer: '_buttonsChanged'
        },
        DailyfilterBy: {
          type: Number,
          value: 1
        },
        open: {
          type: Boolean,
          value: false,
          notify: true
        },
        startDate: {
          type: String,
          value: '',
        },
        endDate: {
          type: String,
          value: '',
        },
        startRange: {
          type: Number,
          value: 0
        },
        startYear: {
          type: Number,
          value: 0
        },
        startMonthYear: {
          type: String,
          value: '2018'
        },
        endMonthYear: {
          type: String,
          value: '2018'
        },
        endYear: {
          type: Number,
          value: 3
        },
        startYears: String,
        endYears: String,
        endRange: Number
      },

      observers: [
        'onChangedAll(selectedDMY,dailyAct,month,year,yearly)',
        'dailyTotalChanged(dailyTotal)',
        'monthlyTotalChanged(monthlyTotal)',
        'yearlyTotalChanged(yearlyTotal)',
        'selectedTabChanged(selectedTab)',
        'selectedReportChanged(selectedReport)',
        'overAllChanged(lotType,overAllDate)',
        '_onYearChanged(startYear,endYear)',
        '_onChanged(selectedDaily,DailyfilterBy,startDate,endDate,startRange,endRange,startYears,endYears,startMonthYear,endMonthYear)'
        // 'selectedDMYChanged(selectedDMY)',
        // 'dailyActChanged(dailyAct)',
        // 'monthlyChanged(month, year)'
      ],


      ready() {
        super.ready();
        var date = new Date();
        this.endRange = date.getMonth();
        this.endDate = this._format(date, 'day');

        date.setDate(date.getDate() - 14);
        this.startDate = this._format(date, 'day');

      },

      _format(date, type) {

        var day = date.getDate();
        var month = date.getMonth() + 1;
        var year = date.getFullYear();
        if (month < 10) { month = '0' + month };
        if (day < 10) { day = '0' + day };

        if (type == 'day') {
          return year + '-' + month + '-' + day;
        }
        if (type == 'month') {
          return year + '-' + month;
        }
        if (type == 'year') {
          return year;
        }
      },

      _onYearChanged(startYear, endYear) {
        if (startYear == 0) {
          this.startYears = '2015'
        } if (startYear == 1) {
          this.startYears = '2016'
        } if (startYear == 2) {
          this.startYears = '2017'
        } if (startYear == 3) {
          this.startYears = '2018'
        }
        if (endYear == 0) {
          this.endYears = '2015'
        } if (endYear == 1) {
          this.endYears = '2016'
        } if (endYear == 2) {
          this.endYears = '2017'
        } if (endYear == 3) {
          this.endYears = '2018'
        }
      },

      _onChanged(selectedDaily, DailyfilterBy, startDate, endDate, startRange, endRange, startYears, endYears, startMonthYear, endMonthYear) {

        if (this.open == true) {
          var selectedType, lotType, text, start, end;

          if (selectedDaily != 0) {
            if (selectedDaily == 1) {
              start = startDate;
              end = endDate;
              selectedType = "/daily";
              // text = 'Daily';
              var Month = Polymer.dom(this.root).querySelector("#Monthly");
              Month.setAttribute("style", "display:none");
              var Day = Polymer.dom(this.root).querySelector("#Daily");
              Day.setAttribute("style", "display:block");
              var Year = Polymer.dom(this.root).querySelector("#Yearly");
              Year.setAttribute("style", "display:none");
            }
            else if (selectedDaily == 2) {
              // text = 'Monthly';
              var startM = parseInt(startRange) + 1;
              start = startMonthYear;
              if (startM < 10) {
                start = startMonthYear + '-0' + startM.toString();
              }

              var endM = parseInt(endRange) + 1;
              end = endMonthYear + '-' + endM.toString();
              if (endM < 10) {
                end = endMonthYear + '-0' + endM.toString();
              }

              var Month = new Date();
              var month = this._format(Month, 'month');

              selectedType = "/monthly";
              text = 'Bone Chamber';

              var Month = Polymer.dom(this.root).querySelector("#Monthly");
              Month.setAttribute("style", "display:block");
              var Day = Polymer.dom(this.root).querySelector("#Daily");
              Day.setAttribute("style", "display:none");
              var Year = Polymer.dom(this.root).querySelector("#Yearly");
              Year.setAttribute("style", "display:none");
            }
            else {
              start = startYears;
              end = endYears;
              selectedType = "/yearly";
              text = 'Lawn Lot ';

              var Month = Polymer.dom(this.root).querySelector("#Monthly");
              Month.setAttribute("style", "display:none");
              var Day = Polymer.dom(this.root).querySelector("#Daily");
              Day.setAttribute("style", "display:none");
              var Year = Polymer.dom(this.root).querySelector("#Yearly");
              Year.setAttribute("style", "display:block");


            }
          }

          if (DailyfilterBy != 0) {
            if (this.DailyfilterBy == 1) {
              lotType = 'activity';
              text = 'All Lot';
            } else if (this.DailyfilterBy == 2) {
              lotType = 'comparative/bonechamber';
              text = 'Bone Chamber ';
            } else if (this.DailyfilterBy == 3) {
              lotType = 'comparative/lawnlots';
              text = 'Lawn Lots';
            }
            else if (this.DailyfilterBy == 4) {
              lotType = 'comparative/cinerarium';
              text = 'Cinerarium';
            }
            else if (this.DailyfilterBy == 5) {
              lotType = 'comparative/wallniche';
              text = 'Wall Niche';
            }
          }

          this.query(lotType, selectedType, text, start, end)
        }
      },

      query(lotType, selectedType, text, start, end) {

        var ctx = Polymer.dom(this.root).querySelector("#myChart");
        var myChart = new Chart(ctx, {
          type: 'line',
          options: {
            plugins: {
              datalabels: {
                anchor: 'end',
                align: 'right'
              }
            },
            responsive: true,
            // title: {
            //   display: true,
            //   fontSize: 18,
            //   text: text + ' ' + 'Comparative Report'
            // }
          }
        });

        if (lotType == 'activity') {
          firebase.database().ref("reports/" + lotType + selectedType)
            .orderByKey().startAt(start).endAt(end).limitToFirst(15).on("value", function (snapshot) {
              var typeHold = [];
              var typeSold = [];
              var typeReserved = [];
              var labels = [];
              snapshot.forEach(element => {
                labels.push(element.key);
                typeSold.push(element.val().totalSold);
                typeHold.push(element.val().totalHold);
                typeReserved.push(element.val().totalReserved);
              });

              var data = {
                labels: labels,
                datasets: [{
                  label: 'Sold',
                  data: typeSold,
                  backgroundColor: 'transparent',
                  borderColor: 'red',
                  borderWidth: 1
                },
                {
                  label: 'Hold',
                  data: typeHold,
                  backgroundColor: 'transparent',
                  borderColor: 'orange',
                  borderWidth: 1
                },
                {
                  label: 'Reserved',
                  data: typeReserved,
                  backgroundColor: 'transparent',
                  borderColor: 'yellow',
                  borderWidth: 1
                }],

              };
              myChart.data = data;
              myChart.update();
            });

        }
        else {
          firebase.database().ref("reports/" + lotType + selectedType)
            .orderByKey().startAt(start).endAt(end).limitToFirst(15).on("value", function (snapshot) {
              var typeHold = [];
              var typeSold = [];
              var typeReserved = [];
              var labels = [];
              snapshot.forEach(element => {
                labels.push(element.key);
                typeSold.push(element.val().totalSold);
                typeHold.push(element.val().totalHold);
                typeReserved.push(element.val().totalReserved);
              });

              var data = {
                labels: labels,
                datasets: [{
                  label: 'Sold',
                  data: typeSold,
                  backgroundColor: 'transparent',
                  borderColor: 'red',
                  borderWidth: 1
                },
                {
                  label: 'Hold',
                  data: typeHold,
                  backgroundColor: 'transparent',
                  borderColor: 'orange',
                  borderWidth: 1
                },
                {
                  label: 'Reserved',
                  data: typeReserved,
                  backgroundColor: 'transparent',
                  borderColor: 'yellow',
                  borderWidth: 1
                }],

              };
              myChart.data = data;
              myChart.update();
            });
        }

      },
      _buttonsChanged(e) {
        if (e == 0) {

        }
        else if (e == 1) {
          this.open = true;
          var compare = Polymer.dom(this.root).querySelector("#comparative");
          compare.setAttribute("style", "display:block");
          var card = Polymer.dom(this.root).querySelector("#card1");
          card.setAttribute("style", "display:block");

          // var text = 'Daily';
          var ctx = Polymer.dom(this.root).querySelector("#myChart");
          var myChart = new Chart(ctx, {
            type: 'line',
            options: {
              plugins: {
                datalabels: {
                  anchor: 'end',
                  align: 'right'
                }
              },
              responsive: true,
              // title: {
              //   display: true,
              //   fontSize: 18,
              //   text: 'Comparative Report'
              // }
            }
          });
          var current = new Date();
          this.currentTime = current.getFullYear() + "-" + ("0" + (current.getMonth() + 1)).slice(-2);
          // console.log(this.currentTime);
          var DailyRunning = firebase.database().ref("reports/activity/daily");
          DailyRunning.orderByKey().startAt(this.currentTime).limitToFirst(15).on("value", function (snapshot) {
            var typeHold = [];
            var typeSold = [];
            var typeReserved = [];
            var labels = [];
            snapshot.forEach(element => {
              // console.log(element.val());
              labels.push(element.key);
              // console.log(labels);
              typeSold.push(element.val().totalSold);
              typeHold.push(element.val().totalHold);
              typeReserved.push(element.val().totalReserved);
            });

            var data = {
              labels: labels,
              datasets: [{
                label: 'Sold',
                data: typeSold,
                backgroundColor: 'transparent',
                borderColor: 'red',
                borderWidth: 1
              },
              {
                label: 'Hold',
                data: typeHold,
                backgroundColor: 'transparent',
                borderColor: 'orange',
                borderWidth: 1
              },
              {
                label: 'Reserved',
                data: typeReserved,
                backgroundColor: 'transparent',
                borderColor: 'yellow',
                borderWidth: 1
              }],

            };
            myChart.data = data;
            myChart.update();
          });
        } else {

        }

      },
      toggleDrawer() {
        this.dispatchEvent(new CustomEvent('toggleDrawer', {
          bubbles: true, composed: true, detail: {
            narrow: this.$.narrow
          }
        }));
        this.$.narrow = !this.$.narrow;
      },

      _formatType(e) {
        if (e == 'lawnlots') return 'Lawn Lots';
        else if (e == 'wallniche') return 'Wall Niche';
        else if (e == 'bonechamber') return 'Bone Chamber';
        else if (e == 'cinerarium') return 'Cinerarium';
        else if (e == 'familylots4') return 'Family Lots 1 (Area=37.45m²)';
        else if (e == 'familylots5') return 'Family Lots 1 (Irregular Lots)';
        else if (e == 'familylots1') return 'Family Lots 2 (Area=53.27m²)';
        else if (e == 'familylots2') return 'Family Lots 2 (Area=52.83m²)';
        else if (e == 'familylots3') return 'Family Lots 2 (Irregular Lots)';
        else if (e == 'gardenlots1') return 'Garden Lots 1 (Area=12.52m²)';
        else if (e == 'gardenlots2') return 'Garden Lots 1 (Area=12.43m²)';
        else if (e == 'gardenlots3') return 'Garden Lots 1 (Irregular Lots)';
        else if (e == 'gardenlots4') return 'Garden Lots 2 (Area=20.00m²)';
        else if (e == 'gardenlots5') return 'Garden Lots 2 (Irregular Lots)';

      },

      _formatNumber(e) {
        if (e == 0) return '-'
        else return e;
      },

      _formatAllNumber(e) {
        if (!e) return '-'
        else return e;
      },

      _formatAllTotal(e, f, g, h, i) {
        if (!e) e = 0;
        if (!f) f = 0;
        if (!g) g = 0;
        if (!h) h = 0;
        if (!i) i = 0;
        if (e == 0 && f == 0 && g == 0 && h == 0 && i == 0) return '-';
        else return e + f + g + h + i;
      },


      tokenChanged() {
        firebase.messaging().onTokenRefresh(function () {
          firebase.messaging().getToken()
            .then(function (refreshedToken) {
              console.log('Token refreshed.');
              resetUI();
            })
            .catch(function (err) {
              console.log('Unable to retrieve refreshed token ', err);
              showToken('Unable to retrieve refreshed token ', err);
            });
        });
      },

      resetUI() {
        firebase.messaging().getToken().then(function (currentToken) {
          if (currentToken) {
            console.log('Got FCM device token:', currentToken);
            // Saving the Device Token to the datastore.
            firebase.database().ref('/users' + this.user.uid + '/token').child(currentToken);
          } else {
            // Need to request permissions to show notifications.
            this.requestNotificationsPermissions();
          }
        }.bind(this)).catch(function (error) {
          console.error('Unable to get messaging token.', error);
        });
      },

      requestNotificationsPermissions() {
        this.$.messaging.requestPermission()
          .then(function () {
            console.log('Notification permission granted.');
            // TODO(developer): Retrieve an Instance ID token for use with FCM.
            // ...
          })
          .catch(function (err) {
            console.log('Unable to get permission to notify.', err);
          });
      },

      handleMessage(payload) {
        console.log('message received', payload);
      },

      selectedTabChanged(e) {
        if (e === 0) {

        }
        else {
          //set default value 
          this.selectedReport = 0;
          //create chart
          if (!this.Chart) {
            var ctx = Polymer.dom(this.root).querySelector("#dailyChart");
            var dailyChart = new Chart(ctx, {
              type: 'horizontalBar',
              data: {},
              options: {
                responsive: true,
                legend: {
                  position: 'top',
                },
                title: {
                  display: true,
                  text: 'Daily Activity Report'
                },
                plugins: {
                  datalabels: {
                    color: 'white',
                    font: {
                      weight: 'bold'
                    },
                  }
                },
                scales: {
                  yAxes: [{
                    stacked: true,
                    ticks: {
                      beginAtZero: true
                    }
                  }],
                  xAxes: [{
                    stacked: true,
                    ticks: {
                      beginAtZero: true
                    }
                  }]
                }
              }
            });
            this.Chart = dailyChart;
          }
          //set  default date
          var d = new Date();
          datestring = d.getFullYear() + "-" + ("0" + (d.getMonth() + 1)).slice(-2) + "-" + ("0" + d.getDate()).slice(-2);

          this.dailyAct = datestring;
          this.year = d.getFullYear();
          this.month = "01";
          this.yearly = d.getFullYear();
        }
      },

      selectedReportChanged(e) {
        if (e == 0) {
          this.selectedDMY = 0;
          this.hideActivity = false;
          this.hideComparative = true;
          this.hideOverAll = true;
        }
        else if (e == 1) {
          this.hideActivity = true;
          this.hideComparative = false;
          this.hideOverAll = true;
        }
        else {
          this.hideActivity = true;
          this.hideComparative = true;
          this.hideOverAll = false;

          if (!this.allChart) {
            var ctx = Polymer.dom(this.root).querySelector("#overAllChart");
            var overAllChart = new Chart(ctx, {
              type: 'pie',
              data: {},
              options: {
                plugins: {
                  datalabels: {
                    color: 'white',
                    font: {
                      weight: 'bold'
                    },
                  }
                },
                responsive: true,
                title: {
                  display: true,
                  text: 'Overall Report'
                }
              }
            });
            this.allChart = overAllChart;
          }

          var d = new Date();
          datestring = d.getFullYear() + "-" + ("0" + (d.getMonth() + 1)).slice(-2) + "-" + ("0" + d.getDate()).slice(-2);
          this.overAllDate = datestring;
          // this.asOf = this.overAllDate;
          this.lotType = 'all';
        }
      },

      onChangedAll(selectedDMY, dailyAct, month, year, yearly) {
        var dailyChart, datestring, query;
        dailyChart = this.Chart;

        if (this.Chart) {

          if (selectedDMY == 0) {
            this.hideMonthSelection = true;
            this.hideYearly = true;
            this.hideDailyInputDate = false;

            this.dailyDate = dailyAct;
            this.yearDate = '';
            this.monthDate = '';
            this.yearlyDate = '';

            query = 'daily/' + dailyAct;
          }

          if (selectedDMY == 1) {
            this.hideDailyInputDate = true;
            this.hideYearly = true;
            this.hideMonthSelection = false;

            this.yearDate = year;
            this.monthDate = month;
            this.dailyDate = '';
            this.yearlyDate = '';

            query = 'monthly/' + year + '-' + month;
          }

          if (selectedDMY == 2) {
            this.hideMonthSelection = true;
            this.hideDailyInputDate = true;
            this.hideYearly = false;

            this.yearlyDate = yearly;
            this.yearDate = '';
            this.monthDate = '';
            this.dailyDate = '';

            query = 'yearly/' + yearly;
          }

          this.query(query, dailyChart);
        }

      },

      query(query, dailyChart) {
        firebase.database().ref('/reports/activity/' + query + '/lotType').on('value', function (snapshot) {
          if (snapshot.exists()) {

            var itemHold = [];
            var itemSold = [];
            var itemReserved = [];
            var itemKey = [];
            // var itemTotalHold = [];

            snapshot.forEach(function (element) {
              var itemhold = element.val().hold;
              var itemsold = element.val().sold;
              var itemreserved = element.val().reserved;
              var itemkey = element.key;
              // var itemtotalhold = element.val().totalHold;

              itemHold.push(itemhold);
              itemSold.push(itemsold);
              itemReserved.push(itemreserved);
              itemKey.push(itemkey);
              // itemTotalHold.push(itemtotalhold);

            });
            var soldColor = [];
            var holdColor = [];
            var reservedColor = [];
            for (var i = 0; i < itemKey.length; i++) {
              soldColor.push('rgb(245,0,0)');
              holdColor.push('rgb(145, 145, 0)');
              reservedColor.push('orange');
            }

            var data = {
              labels: itemKey,
              datasets: [
                {
                  label: 'Sold',
                  data: itemSold,
                  backgroundColor: soldColor,
                  borderColor: [
                    'rgb(245,0,0)'
                  ],
                  borderWidth: 1
                },
                {
                  label: 'Reserved',
                  data: itemReserved,
                  backgroundColor: reservedColor,
                  borderColor: [
                    'orange'
                  ],
                  borderWidth: 1
                },
                {
                  label: 'Hold',
                  data: itemHold,
                  backgroundColor: holdColor,
                  borderColor: [
                    'rgb(145, 145, 0)'
                  ],
                  borderWidth: 1
                }
              ]
            }

            dailyChart.data = data;
            dailyChart.update();
          }
          else {
            var data = {
              labels: [],
              datasets: [
                {
                  label: 'Sold',
                  data: [],
                  backgroundColor: [],
                  borderColor: [
                    'rgb(245,0,0)'
                  ],
                  borderWidth: 1
                },
                {
                  label: 'Reserved',
                  data: [],
                  backgroundColor: [],
                  borderColor: [
                    'orange'
                  ],
                  borderWidth: 1
                },
                {
                  label: 'Hold',
                  data: [],
                  backgroundColor: [],
                  borderColor: [
                    'rgb(145, 145, 0)'
                  ],
                  borderWidth: 1
                }
              ]
            }

            dailyChart.data = data;
            dailyChart.update();
            console.log('No Data')
          }
        });
      },

      overAllChanged(lotType, overAllDate) {
        var que;
        if (lotType == 'all') {
          que = '/overall';
          this.hideSummary = false;
        }
        else {
          que = '/lotType/' + lotType;
          this.hideSummary = true;
        }
        var allChart = this.allChart;
        firebase.database().ref('/reports/overAll/' + overAllDate + que).on('value', function (snapshot) {
          if (snapshot.exists()) {

            var datas = [];
            var labels = [];

            snapshot.forEach(function (element) {
              datas.push(element.val());
              labels.push(element.key);
            });

            var data = {
              datasets: [{
                data: datas,
                backgroundColor: [
                  'green',
                  'orange',
                  'gray',
                  'yellow',
                  'red'
                ]
              }],
              labels: labels,
            }

            allChart.data = data;
            allChart.update();
          }
          else {
            var data = {
              datasets: [{
                data: [],
                backgroundColor: [
                  'green',
                  'orange',
                  'gray',
                  'yellow',
                  'red'
                ]
              }],
              labels: ['available', 'hold', 'notyetavailable', 'reserved', 'sold'],
            }

            allChart.data = data;
            allChart.update();
            // console.log('No Data')
          }
        });
      },

      dailyTotalChanged() {
        if (this.dailyTotal.length > 0) {
          this.totalHold = this.dailyTotal[1].$val;
          this.totalReserved = this.dailyTotal[2].$val;
          this.totalSold = this.dailyTotal[3].$val;
        }
        else {
          this.totalHold = 0;
          this.totalReserved = 0;
          this.totalSold = 0;
        }
      },

      _showSummary() {
        this.showSummary = false;
        this.hideSummary = true;
        this.hideSummaryTable = false;
        this.overallchart = true;

      },

      _hideSummary() {
        this.showSummary = true;
        this.hideSummary = false;
        this.hideSummaryTable = true;
        this.overallchart = false;
      },

      monthlyTotalChanged() {
        if (this.monthlyTotal.length > 0) {
          this.totalHold = this.monthlyTotal[1].$val;
          this.totalReserved = this.monthlyTotal[2].$val;
          this.totalSold = this.monthlyTotal[3].$val;
        }
        else {
          this.totalHold = 0;
          this.totalReserved = 0;
          this.totalSold = 0;
        }
      },

      yearlyTotalChanged() {
        if (this.yearlyTotal.length > 0) {
          this.totalHold = this.yearlyTotal[1].$val;
          this.totalReserved = this.yearlyTotal[2].$val;
          this.totalSold = this.yearlyTotal[3].$val;
        }
        else {
          this.totalHold = 0;
          this.totalReserved = 0;
          this.totalSold = 0;
        }
      },

    })
  </script>
</dom-module>