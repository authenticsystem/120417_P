<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="my-icons.html">
<link rel="import" href="../bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">

<dom-module id="my-account">
  <template>
    <style include="shared-styles">
      :host {
        display: block;

        padding: 10px;
      }

      .pad {
        padding: 0 16px;
        @apply --layout-flex;
        @apply --layout-vertical;
      }

      .primary {
        font-size: 18px;
        text-transform: capitalize;
      }

      .shortText,
      .longText {
        font-size: 12px;
      }

      app-header {
        color: rgb(255, 255, 255);
        background-color: #388E3C;
      }

      paper-icon-button.menu {
        margin-right: 16px;
      }

      iron-image {
        margin: 0 auto;
      }

      paper-button.green {
        background-color: var(--paper-green-500);
        color: white;
        margin-top: 3px;
      }

      paper-button.green[active] {
        background-color: var(--paper-red-500);
      }

      #uploader {
        -webkit-appearance: none;
        /* appearance: none; */
        width: 50%;
        margin-bottom: 10px;
      }

      a {
        text-decoration: none;
        background: yellow;
        padding: 2px;
        border-radius: 3px;
        font-weight: 500;
      }
    </style>

    <firebase-query id="query" path="/accountlist" data="{{account}}" order-by-child="uid" equal-to="{{user.uid}}">
    </firebase-query>
    <!-- <firebase-auth id="auth" status-known="{{statusKnown}}" user="{{user}}" provider="google" on-error="showError"></firebase-auth> -->

    <app-header-layout fullbleed has-scrolling-region>
      <app-header fixed slot="header">
        <app-toolbar primary>
          <paper-icon-button class="menu" icon="my-icons:menu" drawer-toggle on-tap="toggleDrawer"></paper-icon-button>
          <div main-title>My Account</div>
        </app-toolbar>
      </app-header>

      <div class="card">

        <span hidden$="{{user.emailVerified}}">
          <h1>Please verify your account first</h1>
        </span>

        <span hidden$="{{!user.emailVerified}}">
          <div class="card-actions">
            <div class="horizontal justified">
              <div style="float:right">
                <span style="font-size:14px;" hidden$="{{verified}}">
                  Account not link. Link your account
                  <a href="/account-link">here</a>.
                </span>
                
                <span hidden$="{{!verified}}">
                  <iron-icon icon="my-icons:check"></iron-icon> Account linked
                </span>
              </div>
            </div>
          </div>
        </span>
        
        <paper-toast id="toast" text="Successfully updated!"></paper-toast>

      </div>

    </app-header-layout>
  </template>
  <script>
    Polymer({
      is: 'my-account',
      properties: {
        account: {
          type: Object,
        },
        verified: {
          type: Boolean,
          value: false
        }
      },

      _userName(e) {
        if (e) return e;
        else return 'Name not defined';
      },

      _role(e) {
        if (Object.keys(e).length > 0) {
          this.verified = true;
          if (e[0].role) return e[0].role;
          else return 'Role not yet assign'
        }
        else {
          this.verified = false;
          return 'Role Unknown'
        };
      },

      toggleDrawer() {
        this.dispatchEvent(new CustomEvent('toggleDrawer', {
          bubbles: true, composed: true, detail: {
            narrow: this.$.narrow
          }
        }));
        this.$.narrow = !this.$.narrow;
      },
      _upload(e) {
        var fileButton = Polymer.dom(this.root).querySelector("#fileButton");
        var uploader = Polymer.dom(this.root).querySelector("#uploader");

        fileButton.addEventListener('change', function (e) {
          //get file
          var file = e.target.files[0];
          //create storage
          var user = firebase.auth().currentUser;
          var storageRef = firebase.storage().ref('profilePic/' + file.name);
          //upload file
          var uploadTask = storageRef.put(file);
          //update progressbar
          uploadTask.on('state_changed',

            function progress(snapshot) {
              var percentage = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
              uploader.value = percentage;
              if (percentage === 100) {
                var user = firebase.auth().currentUser;
                if (user) {
                  var photoUrl = user.photoURL;
                  console.log(user.photoURL);
                  // Create a reference to the file to delete
                  var desertRef = firebase.storage().refFromURL(user.photoURL);
                  // Delete the file
                  desertRef.delete().then(function () {
                    // File deleted successfully
                    //window.location.reload()
                  }).catch(function (error) {
                    // Uh-oh, an error occurred!
                  });
                }
              }
            },
            function error(err) {
            },
            function () {
              var downloadURL = uploadTask.snapshot.downloadURL;
              var user = firebase.auth().currentUser;
              user.updateProfile({
                photoURL: downloadURL
              }).then(function () {
                // Update successful.
                window.location.reload()
              }).catch(function (error) {
                // An error happened.
              });
            }

          );
        });
      },
      _update() {
        var user = firebase.auth().currentUser;
        var name = Polymer.dom(this.root).querySelector("#name");
        user.updateProfile({
          displayName: name.value
        }).then(function () {
          // Update successful.
          window.location.reload()
        }).catch(function (error) {
          // An error happened.
        });
      }
    })


  </script>
</dom-module>